# AI Reader V2 产品需求文档

## 1. 产品定位

AI Reader 是一个**本地部署的智能小说阅读理解系统**。它将小说文本转化为结构化知识图谱，在其上构建关系图、时间线、世界地图等多维可视化视图，并提供自然语言问答，让用户以智能交互的方式研究和理解小说。

**用户面临的问题**：

长篇小说（尤其是动辄数百上千章的网文）在阅读和研究时存在明显的信息管理困难：
- 人物记不住——出场角色数百，读到后面忘了前面的人是谁
- 关系理不清——人物之间的关系随剧情演变，师徒反目、敌友转换难以追踪
- 前后文对不上——第 800 章提到的设定可能在第 200 章才有伏笔，无法快速回溯
- 世界观庞大——门派、地域、修炼体系、专有名词构成复杂的知识网络，仅靠记忆难以掌握全貌

**产品价值**：

AI Reader 不是一个阅读器，而是一个**小说研究与探索工具**。它为传统的文本阅读叠加了一层结构化的信息层——每个人名、地名、物品都变成可交互的知识节点，整部小说变成一张可查询、可浏览、可提问的知识图谱。同时，这种交互方式也为普通阅读带来了全新的体验：阅读过程中随手点击即可了解人物全貌，随时提问即可获得基于原文的精准回答。

**与 V1 的区别**：

| 维度 | V1 | V2 |
|------|----|----|
| 界面 | 仅 CLI 和 REST API，无前端 | 完整的 Web 前端，可视化交互 |
| 实体展示 | 文本输出 | 交互式实体卡片（人物/地点/物品/组织 + 概念百科） |
| 知识图谱 | 静态数据导出 | 四种可视化视图（关系图/世界地图/时间线/势力图）+ 章节范围探索 |
| 问答 | 单次 CLI 调用 | 流式对话界面，支持连续追问和来源溯源 |
| 架构 | 9 个重叠 Store，紧耦合 | 统一存储，模块化设计 |

---

## 2. 用户角色

本产品面向**单一用户类型**：需要深入研究小说内容的中文阅读者。具体包括以下几种典型画像：

**网文作家**：写到第 800 章时忘了第 200 章某角色的设定细节，需要快速回溯；或者研究同类作品的人物关系结构和世界观设计作为参考。

**编辑/书评人**：需要系统性地分析一部作品的叙事结构、人物弧光和情节编排，产出结构化的分析报告。

**重度读者**：同时追读多部长篇连载，需要管理跨作品的知识，避免混淆不同小说的人物和设定。

**共同特征**：
- 中文母语用户
- 桌面端使用（长时间深度阅读场景）
- 不排斥本地部署，但不应要求命令行操作能力

**技术门槛说明**：V2 初期需要用户自行安装 Ollama 并下载模型，系统提供引导流程降低门槛。后续迭代考虑支持在线 LLM API 接入或内置模型管理器，进一步降低使用门槛。

---

## 3. 核心场景

> 本节的全局交互规则（章节引用跳转、实体名交互、实体卡片展示形态、实体消歧等）统一定义在第 6 节"交互规则"中，场景描述中不再重复。

### 3.1 上传小说

用户打开应用，上传一本文本小说（.txt 或 .md），系统自动完成章节切分和元信息识别，将小说导入数据库。

#### 3.1.1 上传流程

1. 用户点击"上传小说"，选择本地 .txt 或 .md 文件
2. 系统进行文件解析：识别编码、检测章节边界、提取元信息
3. 显示**上传预览页**，用户确认后导入

上传过程中显示进度（文件读取 → 编码识别 → 章节切分 → 写入数据库）。

#### 3.1.2 章节切分

系统按以下优先级尝试自动切分章节：

| 优先级 | 模式 | 示例 |
|--------|------|------|
| 1 | "第X章" + 可选标题 | 第一章 大山里的孩子、第 123 章 突围 |
| 2 | "第X回" / "第X节" / "第X卷" | 第一回 风起云涌 |
| 3 | 数字序号 + 标题 | 1. 开端、001 初入江湖 |
| 4 | Markdown 标题 (# / ##) | # 第一章 |
| 5 | 分隔线 (--- 或 ===) | 连续分隔符 |

切分完成后进入**上传预览页**，展示：

- 检测到的章节列表（序号 + 标题 + 字数）
- 总章节数和总字数
- 如果切分结果异常（如仅 1 章、或单章超过 5 万字），显示警告提示

**切分调整**（P1）：预览页提供"调整切分"功能，用户可以：
- 在列表中选择某个切分点，删除或新增
- 切换切分模式（从上表中选择另一种模式重新切分）
- 手动输入自定义正则表达式

P0 阶段如果自动切分结果不理想，用户可以删除重新上传。

#### 3.1.3 元信息识别

| 字段 | 识别方式 | 用户可编辑 |
|------|----------|------------|
| 书名 | 从文件名或文件首行提取 | 是 |
| 作者 | 从文件内容中匹配"作者：XXX"模式 | 是 |

预览页中书名和作者显示为可编辑的输入框，用户确认后保存。

#### 3.1.4 重复检测

上传时如果检测到书架中已存在相同书名的小说，弹出对比面板：

> **检测到同名小说《凡人修仙传》已存在**
>
> | | 已有版本 | 新上传 |
> |---|---------|--------|
> | 章节数 | 2,000 章 | 2,451 章 |
> | 总字数 | 680 万字 | 830 万字 |
> | 导入时间 | 2025-01-15 | — |
>
> [ 覆盖已有版本 ]　[ 作为新书导入 ]　[ 取消 ]

选择"覆盖"会清除旧版本的所有分析数据（因为章节结构可能已变化）。

#### 3.1.5 文件限制

| 限制 | 值 | 说明 |
|------|----|------|
| 支持格式 | .txt / .md | 纯文本格式 |
| 编码 | UTF-8（自动检测，失败时提供手动选择） | 支持 GBK/GB2312/UTF-8 |
| 文件大小 | 无硬性限制，超过 100 MB 时提示"文件较大，导入过程可能较慢" | 本地应用不受上传带宽限制 |
| 章节数 | 无限制 | 超过 3,000 章时提示建议分批分析 |

---

### 3.2 阅读小说

用户可以阅读已上传的小说，通过左侧章节目录切换到不同章节，或翻页到上下章节。对于已分析过的章节，阅读模式下被识别的实体名会用对应类别的颜色高亮（人物蓝色、地点绿色、物品橙色、组织紫色、概念灰色），用户点击高亮实体名，会在右侧弹出对应的实体卡片。

系统为每本小说记录用户最后阅读的章节位置，下次打开时自动恢复到上次位置。

**章节目录侧栏**：左侧侧栏以树形结构展示章节目录，支持多级折叠：

- **有卷结构的小说**：按 卷 > 章 两级层级展示。卷标题行显示折叠图标（▼ 展开 / ▶ 折叠）和该卷的分析进度（如"5/10 ✓"），点击卷标题可展开或折叠其下属章节。
- **无卷结构的小说**：退化为平铺的章节列表，与有卷结构的章节行样式一致。
- 当前正在阅读的章节高亮显示，并自动展开其所在的卷。
- 每个章节标注分析状态图标（详见 3.5.4）。
- 侧栏顶部提供章节搜索框，可按章节名快速定位。
- 侧栏可通过 « 按钮折叠以获得更大的阅读区域。

---

#### 3.2.1 人物卡片

人物卡片是信息量最大的实体卡片，展示一个角色在整部小说中的完整画像。卡片内容按以下区块组织。

**A. 基本信息**

| 字段 | 说明 |
|------|------|
| 人物画像 | 默认占位头像（按性别/类型区分），后续版本考虑接入 AI 图像生成 |
| 姓名 | 主要名称 |
| 别称 | 按首次出现章节排列，标注出处。默认显示前 5 个，超出部分折叠，显示"共 X 个别称 ▸ 展开" |
| 性别 | 男 / 女 / 未知 |

别称示例：

> 二愣子（第 1 章）、韩立（第 2 章）、韩师傅（第 5 章）、韩大仙（第 111 章）、韩老魔（第 2000 章）…… 共 12 个别称 ▸ 展开

**B. 外貌特征**

按章节顺序排列，展示人物外貌在故事推进中的变化。默认显示最近 3 条（倒序），可展开查看全部：

> 第 150 章：身着青色道袍，气质出尘
>
> 第 23 章：面容清秀，目光有神
>
> 第 1 章：瘦弱的少年，面色蜡黄
>
> 共 15 条记录 ▸ 展开全部

**C. 人物关系**

展示该人物与其他角色的关系，核心特点是**关系随章节演变**。人物包含所有智慧生物（宠物、机器人、怪兽等）。

按关系中最新章节倒序排列，默认显示前 10 条。超出部分折叠，点击"查看全部"打开独立的**人物关系弹窗**。

每条关系展示完整演变链：

> **张翠山** — 初见（第 1 章）→ 同学（第 2 章）→ 恋人（第 3 章）→ 妻子（第 6 章）→ 仇人（第 8 章）→ 前妻（第 30 章）
>
> **墨大夫** — 初见（第 10 章）→ 师傅（第 10 章）→ 朋友（第 16 章）→ 岳父（第 18 章）
>
> **王掌柜** — 初见（第 2 章）→ 老板（第 26 章）
>
> ……共 87 条关系 ▸ 查看全部

关系链中的每个节点包含：关系类型 + 章节编号。点击对方人物名可打开其人物卡片。

**D. 能力**

人物的能力按维度分组展示，每个维度内按章节顺序排列。维度分类由系统自动推断，无法归类的条目放入"其他"分组。每个维度默认展开，条目超过 5 条时折叠多余部分。

**境界/修为**（成长路径，展示升级线）：

> 练气三层（第 5 章）→ 练气七层（第 12 章）→ 筑基成功（第 23 章）→ 结丹（第 89 章）→ ……

**技能/武功**（独立获取，各自标注出处和使用记录）：

> 火球术 — 习得（第 6 章），使用（第 23/25/31 章）
>
> 隐身术 — 习得（第 15 章），使用（第 18 章）
>
> 御剑术 — 习得（第 30 章）

**身份/职业**（可能多次变化）：

> 药园学徒（第 3 章）→ 外门弟子（第 12 章）→ 内门弟子（第 25 章）→ 长老（第 200 章）

**E. 物品关系**

人物关联的物品，按首次出现章节排列。物品名为实体，可点击查看物品卡片。每个物品标注**持有状态的变化**（获得、使用、消耗、赠送、丢失等）：

> `小绿瓶` — 获得（第 8 章）→ 使用（第 12/45/47 章）→ 赠予 `厉飞雨`（第 89 章），共出现 34 章
>
> `隐身符` — 获得（第 10 章）→ 消耗（第 12 章）
>
> `筑基丹` — 获得（第 40 章）→ 服用（第 45 章）
>
> `青竹蜂云剑` — 获得（第 55 章）→ 使用（第 56/78/102/……/980 章），共出现 128 章

章节引用规则：列出所有出现章节；超过 10 章时，显示前 5 章 + 省略号 + 后 5 章 + 总数。默认显示前 10 个物品，超出部分折叠。

**F. 经历**

按该人物出现的章节顺序排列，概述每章中该人物在什么地点、与什么人发生了什么事。其中地点名和人物名均为实体（高亮可点击）。

卡片内默认显示**最近 5 章**的经历（倒序，最新在前），底部标注"共出现 X 章"。点击可展开独立的**人物经历弹窗**，查看完整经历列表（正序，支持滚动浏览和按章节跳转）。

卡片内预览示例：

> **第 5 章**：在 `练功房` 突破练气三层，引起 `张铁` 注意
>
> **第 3 章**：在 `药园` 学习辨认灵药，`墨大夫` 开始传授基础药理
>
> **第 2 章**：被带到 `七玄门` 山门前，通过入门测试，进入 `药园` 成为学徒
>
> **第 1 章**：在 `浮云山` 闲逛时遇到劫匪，逃跑途中在 `山脚官道` 遇到路人相助
>
> 共出现 328 章 ▸ 查看完整经历

人物经历弹窗中按章节正序排列，展示全部经历：

> **第 1 章**：在 `浮云山` 闲逛时遇到劫匪，逃跑途中在 `山脚官道` 遇到路人相助
>
> **第 2 章**：被带到 `七玄门` 山门前，通过入门测试，进入 `药园` 成为学徒
>
> **第 3 章**：在 `药园` 学习辨认灵药，`墨大夫` 开始传授基础药理
>
> ……（全部章节）

每条经历包含：章节编号 + 地点（实体高亮）+ 人物（实体高亮）+ 事件概要。同一章内若涉及多个地点，按叙述顺序排列。

**G. 数据统计**（卡片底部折叠区域）

| 统计项 | 说明 |
|--------|------|
| 出场章节数 | 在多少章中出现 |
| 首次出场 | 第 X 章 |
| 最后出场 | 第 X 章 |
| 关联人物数 | 与多少个其他人物有关系 |
| 关联物品数 | 持有/使用过多少物品 |
| 到访地点数 | 去过多少个地点 |

---

#### 3.2.2 地点卡片

地点卡片展示一个地点在小说世界中的完整画像——它是什么、在哪里、长什么样、谁来过、发生过什么。

**A. 基本信息**

| 字段 | 说明 |
|------|------|
| 地点名称 | 主要名称 |
| 别称 | 按首次出现章节排列。如：七玄门（第 2 章）、七玄派（第 15 章）、七玄遗址（第 300 章）。默认显示前 5 个，超出折叠 |
| 地点类型 | 国家 / 地区 / 城市 / 山脉 / 门派 / 建筑 / 房间 / 自然地貌 / 其他。由系统推断，可手动修正 |
| 首次提及 | 第 X 章 |

**B. 空间层级**

展示该地点在世界空间中的位置关系，分为三层：

**上级地点**（该地点属于哪里）：

> `越国` → `悦洲` → `太南小国` → `七玄门` → **药园** ← 当前

层级链中每个地点名均为实体，可点击查看其地点卡片。

**下级地点**（该地点包含哪些子地点）：

> `百药堂`、`炼丹房`、`灵药圃`、`守园小屋`

默认全部展示，超过 10 个时折叠，显示"共 X 个子地点 ▸ 展开"。

**相邻/关联地点**（同级或有空间关系的地点）：

> `练功房`（相邻）、`藏经阁`（相邻）、`主峰大殿`（同属七玄门）

**C. 环境描写**

按章节顺序排列，展示小说中对该地点的描写。地点可能随故事发展而变化（如战后变为废墟）。默认显示最近 3 条（倒序），可展开查看全部：

> 第 300 章：大殿坍塌，灵脉枯竭，只剩残垣断壁
>
> 第 50 章：山门气派，弟子往来不绝，灵气充裕
>
> 第 2 章：隐于群山之中的小门派，规模不大但环境清幽
>
> 共 12 条记录 ▸ 展开全部

**D. 到访人物**

在此地点出现过的人物，按最后出现章节倒序排列。区分**常驻**和**到访**两类：

**常驻**（在该地点长期生活/工作的人物）：

> `墨大夫`（第 2 - 50 章）
>
> `余子同`（第 2 - 45 章）

**到访**（在该地点短暂出现的人物）：

> `韩立` — 第 2/3/5/8/12/……/50 章，共 28 章
>
> `厉飞雨` — 第 10/12 章
>
> `张铁` — 第 5 章

默认显示常驻全部 + 到访前 10 名（按出现章节数倒序），超出部分点击"查看全部"打开独立弹窗。

**E. 发生事件**

在此地点发生的重要事件，按章节顺序排列。事件描述中的人物名和地点名均为实体（高亮可点击）。

卡片内默认显示最近 5 条（倒序），点击展开独立的**地点事件弹窗**查看全部（正序）。

卡片内预览示例：

> **第 50 章**：`七玄门`遭 `魔道` 偷袭，`韩立` 在 `药园` 拼死守护灵药
>
> **第 12 章**：`墨大夫` 在 `药园` 考核弟子，`韩立` 通过考验获得 `小绿瓶`
>
> **第 5 章**：`韩立` 在 `药园` 旁的 `练功房` 突破练气三层
>
> **第 3 章**：`墨大夫` 开始在 `药园` 传授 `韩立` 基础药理
>
> **第 2 章**：`韩立` 首次进入 `药园`，成为学徒
>
> 共 18 条事件 ▸ 查看全部

**F. 数据统计**（卡片底部折叠区域）

| 统计项 | 说明 |
|--------|------|
| 提及章节数 | 在多少章中被提及 |
| 首次提及 | 第 X 章 |
| 最后提及 | 第 X 章 |
| 子地点数 | 包含多少个下级地点 |
| 到访人物数 | 多少个人物在此出现过 |
| 发生事件数 | 在此地点发生了多少件事 |

#### 3.2.3 物品卡片

物品卡片展示一件物品的属性、流转轨迹和使用历史。核心特点是**物品在角色之间的流转链**。

**A. 基本信息**

| 字段 | 说明 |
|------|------|
| 物品名称 | 主要名称 |
| 别称 | 按首次出现章节排列。如：碧灵丹（第 40 章）、筑基丹（第 42 章）。默认显示前 5 个，超出折叠 |
| 物品类型 | 武器 / 防具 / 丹药 / 符箓 / 法宝 / 材料 / 书籍 / 日用 / 其他。由系统推断 |
| 首次出现 | 第 X 章 |

**B. 物品描述**

按章节顺序排列，展示小说中对该物品的描写（外观、功效、来历等）。物品的描述可能随故事推进逐步揭示更多信息。默认显示最近 3 条（倒序），可展开查看全部：

> 第 45 章：服下后全身经脉剧痛，灵力暴涨，成功筑基
>
> 第 42 章：墨大夫解释此丹可助练气期修士突破筑基，但有三成失败风险
>
> 第 40 章：拳头大小的暗金色丹药，散发浓郁灵气
>
> 共 5 条记录 ▸ 展开全部

**C. 持有流转**

展示物品在角色之间的完整流转链，这是物品卡片最核心的区块。每个节点包含：持有人 + 获得方式 + 章节。

> `墨大夫` 炼制（第 38 章）→ 赠予 `韩立`（第 40 章）→ `韩立` 服用（第 45 章，已消耗）

更复杂的流转示例（耐久性物品）：

> `铸剑师王林` 铸造（第 50 章）→ 售予 `韩立`（第 55 章）→ `韩立` 持有使用（第 55 - 980 章）

流转链中人物名均为实体，可点击查看人物卡片。物品的最终状态标注在链尾：**持有中** / **已消耗** / **已损毁** / **已遗失** / **已赠出**。

**D. 使用记录**

物品被使用的具体场景，按章节排列。卡片内默认显示最近 5 条（倒序），点击展开独立弹窗查看全部（正序）。

> **第 980 章**：`韩立` 在 `落日峰` 以 `青竹蜂云剑` 击败 `赤焰老祖`
>
> **第 102 章**：`韩立` 在 `坊市` 以 `青竹蜂云剑` 斩杀偷袭的魔修
>
> **第 78 章**：`韩立` 在 `试剑台` 首次实战使用 `青竹蜂云剑`
>
> **第 56 章**：`韩立` 在 `练功房` 初次祭炼 `青竹蜂云剑`
>
> 共 128 次使用 ▸ 查看全部

每条记录包含：章节编号 + 使用者（实体高亮）+ 地点（实体高亮）+ 事件概要。

**E. 关联物品**

与该物品有关联的其他物品（如配套、材料、升级关系等）：

> `蜂王精` — 喂养材料（第 60/80/120 章）
>
> `金竹` — 铸造材料（第 50 章）

条目较少时全部展示，超过 5 个时折叠。

**F. 数据统计**（卡片底部折叠区域）

| 统计项 | 说明 |
|--------|------|
| 出现章节数 | 在多少章中被提及 |
| 首次出现 | 第 X 章 |
| 最后出现 | 第 X 章 |
| 持有人数 | 历经多少个持有者 |
| 使用次数 | 被使用了多少次 |
| 当前状态 | 持有中 / 已消耗 / 已损毁 / 已遗失 |

---

#### 3.2.4 组织卡片

组织卡片展示一个组织（门派、家族、势力、国家等）的结构、成员和发展历程。核心特点是**成员的加入/离开/职位变化**和**组织间关系**。

**A. 基本信息**

| 字段 | 说明 |
|------|------|
| 组织名称 | 主要名称 |
| 别称 | 按首次出现章节排列。如：七玄门（第 2 章）、七玄派（第 15 章）。默认显示前 5 个，超出折叠 |
| 组织类型 | 门派 / 家族 / 势力 / 帮派 / 国家 / 军队 / 商会 / 其他。由系统推断 |
| 首次提及 | 第 X 章 |

**B. 组织描述**

按章节顺序排列，展示小说中对该组织的描写（规模、实力、声望等）。默认显示最近 3 条（倒序），可展开查看全部：

> 第 300 章：遭魔道突袭后元气大伤，仅存弟子不足百人
>
> 第 50 章：越国七大修仙门派之一，弟子数百，拥有数位筑基期长老
>
> 第 2 章：隐于群山中的小门派，在当地颇有名望
>
> 共 8 条记录 ▸ 展开全部

**C. 组织层级**

展示该组织在势力版图中的位置关系：

**上级组织**（该组织隶属于哪个更大的势力）：

> `越国修仙界` → **七玄门** ← 当前

**下级/分支**（该组织包含的子组织或内部机构）：

> `百药堂`、`百锻堂`、`聚宝堂`、`外门`、`内门`、`长老会`

默认全部展示，超过 10 个时折叠。

**同级/关联组织**（同一体系下的平级组织或有关系的外部组织）：

> `黄枫谷`（盟友，第 15 章）、`掩月宗`（世仇，第 20 章）、`血手门`（敌对，第 45 章）

关系类型标注：盟友 / 敌对 / 从属 / 竞争 / 中立。

**D. 成员**

组织的成员列表，核心特点是**成员身份随章节变化**。按成员最新章节倒序排列。

默认显示前 10 名，超出部分点击"查看全部"打开独立弹窗。

> **`韩立`** — 入门（第 2 章）→ 药园学徒（第 3 章）→ 外门弟子（第 12 章）→ 内门弟子（第 25 章）→ 离开（第 55 章）
>
> **`墨大夫`** — 药园管事（第 2 章）→ 阵亡（第 50 章）
>
> **`余子同`** — 外门弟子（第 2 章）→ 内门弟子（第 20 章）→ 离开（第 48 章）
>
> **`李师兄`** — 内门弟子（第 2 章）→ 长老（第 30 章）
>
> ……共 45 名成员 ▸ 查看全部

成员身份链的最终状态标注：**在职** / **离开** / **阵亡** / **叛出** / **逐出**。

**E. 据点/领地**

组织控制或关联的地点，地点名为实体可点击：

> `七玄门山门`（总部，第 2 章起）
>
> `七玄坊市`（下属，第 15 章起）
>
> `落日峰`（分坛，第 80 章起）→ 失守（第 300 章）

标注地点与组织的关系（总部 / 分部 / 领地 / 驻地）及状态变化。

**F. 大事记**

组织经历的重大事件，按章节排列。卡片内默认显示最近 5 条（倒序），点击展开独立弹窗查看全部（正序）。

> **第 300 章**：`魔道` 大举进攻，`七玄门` 山门被破，大量弟子阵亡
>
> **第 80 章**：`七玄门` 在 `落日峰` 建立分坛，势力扩张
>
> **第 50 章**：`七玄门` 与 `黄枫谷` 结盟，共同应对 `血手门` 威胁
>
> **第 15 章**：`七玄门` 七大门派会武，`韩立` 代表出战
>
> **第 2 章**：`七玄门` 招收新弟子，`韩立` 入门
>
> 共 22 件大事 ▸ 查看全部

**G. 数据统计**（卡片底部折叠区域）

| 统计项 | 说明 |
|--------|------|
| 提及章节数 | 在多少章中被提及 |
| 首次提及 | 第 X 章 |
| 最后提及 | 第 X 章 |
| 成员总数 | 历史上有多少成员 |
| 现有成员数 | 当前状态为"在职"的成员 |
| 据点数 | 控制多少个地点 |
| 关联组织数 | 与多少个其他组织有关系 |

---

#### 3.2.5 概念高亮

阅读页中，小说特有的概念和术语（如修炼等级"练气期"、货币"灵石"、种族"妖兽"等）以灰色高亮显示。点击概念名弹出一个**轻量浮层**（非完整卡片），展示：

| 字段 | 说明 |
|------|------|
| 概念名称 | 如"筑基期" |
| 定义 | 系统从原文中综合提炼的解释，如"修仙第二境界，突破练气期后达到，实力远超练气期修士" |
| 所属分类 | 如"修炼体系" |
| 首次提及 | 第 X 章 |
| 关联概念 | 如"练气期"、"结丹期" |

浮层底部提供"在百科中查看"链接，跳转到百科页面查看该概念的完整词条。

概念不需要像人物/地点那样的完整卡片——它们是知识性条目而非叙事实体。

---

### 3.3 知识图谱可视化

用户完成小说分析后，可以通过多种可视化视图从全局视角浏览小说的结构。知识图谱可视化是独立于阅读的一个主要功能区域，包含四个视图：人物关系图、世界地图、时间线、势力图。

> **全局交互：章节范围滑块**
>
> 所有可视化视图顶部都提供一个**章节范围滑块**，用户可以拖动选择章节区间（如第 1 - 50 章），视图只展示该区间内的数据。这让用户可以观察关系网络和世界格局在故事不同阶段的状态。滑块范围为第 1 章到已分析的最后一章。

> **全局交互：节点可点击**
>
> 所有视图中的节点（人物、地点、组织等）均为实体，点击后弹出对应的实体卡片。

---

#### 3.3.1 人物关系图

以力导向图（force-directed graph）展示人物之间的关系网络。

**节点**：
- 每个节点代表一个人物
- 节点大小：按出场章节数（或关系数）映射，出场越多节点越大
- 节点颜色：按阵营/组织归属区分颜色。未归属组织的为默认灰色
- 节点标签：人物姓名，过于密集时只显示主要人物的标签，缩放后逐步显示

**边**：
- 每条边代表两个人物之间的关系
- 边的标签：当前（或所选章节范围内最新的）关系类型
- 边的粗细：按互动章节数映射，互动越多边越粗
- 边的颜色：按关系大类区分——亲属(暖色)、友好(绿色)、敌对(红色)、组织(蓝色)、其他(灰色)

**交互操作**：

| 操作 | 效果 |
|------|------|
| 拖拽画布 | 平移视图 |
| 滚轮缩放 | 放大/缩小，缩放级别影响标签显示密度 |
| 拖拽节点 | 移动单个节点位置（松手后固定或回弹，可配置） |
| 点击节点 | 弹出该人物的实体卡片 |
| 悬浮节点 | 高亮该人物及其所有直接关系，其余节点和边变半透明 |
| 点击边 | 弹出关系详情浮层：关系演变链 + 关键章节 |
| 双击节点 | 以该节点为中心重新布局，只展示 N 跳内的关系网络（聚焦模式） |

**筛选面板**（侧边栏或顶栏下拉）：

| 筛选维度 | 选项 |
|----------|------|
| 实体类型 | 人物 / 智慧生物（宠物等）/ 全部 |
| 关系类型 | 多选：亲属 / 师徒 / 友好 / 敌对 / 恋爱 / 组织从属 / 全部 |
| 组织归属 | 多选：按组织名筛选，只看某个门派的人物关系 |
| 最少出场数 | 滑块，过滤掉只出现 N 章以下的次要人物 |

**路径查找**：

用户可以选择两个人物节点，系统高亮它们之间的最短关系路径。用于发现两个看似无关的人物之间的间接联系。

> 操作方式：选中第一个节点后按住 Shift 点击第二个节点，或在搜索框中输入两个人物名。

---

#### 3.3.2 世界地图

展示小说中所有地点的空间关系和人物移动轨迹。提供两种视图模式，可通过顶部标签切换：

---

##### 视图 A：空间地图（默认）

以风格化示意图呈现小说世界的空间结构——类似奇幻小说扉页地图或策略游戏大地图，而非精确地理地图。地点以图标节点形式自由放置在画布上，通过区域、连线和方位关系呈现空间感。

**地图性质与实现方向**：

这张地图**不是** tile 网格地图（不需要地形瓦片、碰撞检测等游戏概念），而是一张**节点-区域型的空间示意图**。核心数据是地点节点和它们之间的空间关系（包含、相邻、方位），不涉及精确坐标或地形绘制。

技术方向建议：高性能 2D Canvas 渲染库（如 Pixi.js）处理大量节点的渲染和平滑缩放，上层自行实现语义缩放、区域渲染和交互逻辑。不建议使用 Tiled/Phaser 等 tile 地图工具链——它们解决的是"拼地形瓦片"的问题，而这里的问题是"布局和展示关系型空间数据"。

**地图生成**：

系统根据小说中提取的空间关系（方位词"在……以北"、距离描述"相隔千里"、包含关系等）自动推算各地点的相对坐标并布局。布局算法以力导向布局为基础，叠加空间约束（如 A 在 B 以北 → A 的 y 坐标小于 B），生成符合小说描述的空间排布。地图不追求地理精确，而是呈现**符合文本语义的空间感**。

用户可手动拖拽调整地点位置（调整后持久化保存），系统布局和用户调整混合存储，用户调整优先。

**视觉风格**：

地图整体采用**手绘风格化**处理，营造古籍地图/奇幻地图的质感：
- 画布底色：羊皮纸/宣纸质感背景
- 区域边界：手绘风格线条，非机械直线
- 连接线：墨水笔触风格的曲线
- 整体色调偏暖/复古

（视觉风格为建议方向，具体实现时可调整。核心是不要做成科技感的数据看板，而是贴近"一本书的世界地图"的感觉。）

**多级缩放（核心体验）**：

地图采用**语义缩放**，不同缩放级别展示不同粒度的内容：

| 缩放级别 | 显示内容 | 类比 |
|----------|----------|------|
| 级别 1（最远） | 大洲/世界/大区域的轮廓和名称 | 奇幻小说世界总览 |
| 级别 2 | 国家/大区域 + 主要城市/山脉 | 某个大洲的区域图 |
| 级别 3 | 城市/门派/重要地标 + 地点间路线 | 某个国家/区域的详图 |
| 级别 4 | 建筑/街道/具体设施 | 某个城镇/门派的内部 |
| 级别 5（最近） | 房间/内部结构 | 某栋建筑的内部布局 |

缩放过程平滑过渡。放大时：低层级地点（如国家轮廓）逐渐淡化为背景，高层级地点（如门派内部建筑）逐步显现。缩小时反之。每个级别只显示该粒度适合的地点标签，避免信息过载。

**区域与边界**：

- 包含子地点的地点（如国家、门派）渲染为**半透明区域色块**，形状为包围其子地点的凸包或圆角矩形
- 区域色块颜色按势力/阵营区分，让用户一眼看出势力范围
- 相邻关系以虚线边界表示
- 区域支持嵌套：放大到门派级别时，门派区域内可见其下属堂口的子区域

**地点标记样式**：

| 元素 | 样式 |
|------|------|
| 地点图标 | 按类型使用不同图标：城市(城堡)、山脉(山峰)、门派(殿堂)、水域(波浪)、建筑(房屋)等 |
| 图标大小 | 按提及章节数映射，提及越多图标越大 |
| 标签 | 地点名称，缩放级别不够时隐藏，避免重叠 |
| 热度指示 | 可选叠加层：按提及频率渲染热力色（从冷色到暖色），快速看出哪些是故事热点区域 |

**人物轨迹叠加层**：

用户可以选择一个或多个人物，在空间地图上叠加展示其移动轨迹：

- 轨迹以**带箭头的曲线**连接地点，沿途标注章节编号
- 轨迹线从起点到终点有渐变色（浅→深），体现时间方向
- 多个人物的轨迹用不同颜色区分
- 轨迹动画：点击"播放"按钮后，轨迹按章节顺序逐段出现，配合章节范围滑块同步移动，可暂停/拖拽跳转
- 轨迹上的关键节点（停留超过 N 章的地点）标记为较大的圆点

> 示例：选择"韩立"，点击播放后，一条蓝色轨迹从 `浮云山` 出发，经过 `七玄门`，在 `药园` 停留较久（大圆点），再移动到 `坊市`……随着播放推进，章节滑块同步右移。

**交互操作**：

| 操作 | 效果 |
|------|------|
| 滚轮缩放 | 语义缩放，不同级别显示不同粒度的地点 |
| 拖拽画布 | 平移地图 |
| 点击地点 | 弹出地点卡片 |
| 悬浮地点 | 浮层：地点名、类型、提及章节数、到访人物数、上级地点 |
| 拖拽地点图标 | 手动调整地点位置（长按 0.5 秒进入编辑模式，松手保存） |
| 点击轨迹线段 | 显示该段移动的章节和事件概要 |
| 播放按钮 | 轨迹动画播放/暂停 |

---

##### 视图 B：层级地图

以结构化的树状视图展示地点的包含关系，适合精确浏览地点层级，作为空间地图的补充。

以嵌套矩形（treemap）或可折叠树的方式展示：

```
越国
├── 太南山脉
│   ├── 七玄门
│   │   ├── 药园
│   │   ├── 练功房
│   │   ├── 藏经阁
│   │   └── 主峰大殿
│   └── 黄枫谷
│       ├── ……
└── 越国王城
    ├── ……
```

**节点样式**：
- 节点大小：按提及章节数映射
- 节点颜色：按地点类型区分——自然地貌(绿色)、城镇(橙色)、门派/建筑(蓝色)、其他(灰色)
- 节点标签：地点名称

**交互操作**：

| 操作 | 效果 |
|------|------|
| 点击节点 | 弹出地点卡片 |
| 双击节点 | 展开/折叠该地点的子地点 |
| 悬浮节点 | 浮层：地点名、类型、提及章节数、到访人物数 |
| 点击"在空间地图中定位" | 切换到空间地图并居中显示该地点 |

---

##### 世界地图筛选面板（两种视图共享）

| 筛选维度 | 选项 |
|----------|------|
| 地点类型 | 多选：国家 / 城市 / 山脉 / 门派 / 建筑 / 其他 |
| 叠加人物轨迹 | 多选：选择要显示轨迹的人物 |
| 最少提及数 | 滑块：过滤低频提及的地点 |
| 热度叠加层 | 开关：是否显示提及频率热力图（仅空间地图） |

---

#### 3.3.3 时间线

以水平轴展示小说中的事件在叙事时间或章节维度上的分布。

**坐标轴**：
- 横轴：章节编号（默认）或故事内时间（如果小说有明确的时间体系）
- 两种模式可切换

**事件节点**：
- 每个事件显示为轴上的一个圆点，悬浮显示事件摘要
- 节点大小：按事件重要度映射
- 节点颜色：按事件类型区分——战斗(红色)、修炼/成长(蓝色)、社交/关系变化(绿色)、旅行/移动(橙色)、其他(灰色)

**多泳道模式**：

用户可选择按人物分泳道，每个人物一条横向轨道，展示各自的事件线。适合对比多个人物的活动节奏：

```
韩立    ●──●────●──────●●──●────●──────●──
墨大夫  ──●──●──────●──●──────────────────
张铁    ────────●──●────────────●─────────
        第1章                          第50章
```

**交互操作**：

| 操作 | 效果 |
|------|------|
| 悬浮事件节点 | 浮层显示：事件摘要、涉及人物、发生地点、章节 |
| 点击事件节点 | 跳转到该章节对应位置进行阅读 |
| 框选区域 | 放大该时间段 |
| 拖拽 | 左右平移时间线 |
| 滚轮 | 缩放时间粒度 |

**筛选面板**：

| 筛选维度 | 选项 |
|----------|------|
| 事件类型 | 多选：战斗 / 成长 / 社交 / 旅行 / 其他 |
| 涉及人物 | 多选：按人物筛选（或切换到泳道模式） |
| 涉及地点 | 多选：只看某些地点发生的事件 |
| 重要度阈值 | 滑块：过滤低重要度事件 |

---

#### 3.3.4 势力图

以网络图展示组织之间的关系和各组织的实力对比。

**节点**：
- 每个节点代表一个组织
- 节点大小：按成员数量映射
- 节点颜色：按组织类型区分——门派(蓝色)、家族(橙色)、国家(紫色)、其他(灰色)
- 节点内容：组织名 + 成员数

**边**：
- 表示组织间的关系
- 边的颜色/样式：盟友(绿色实线)、敌对(红色实线)、从属(蓝色虚线)、竞争(橙色虚线)
- 边的标签：关系类型 + 建立/变化的章节

**组织内部展开**：

双击组织节点可展开为内部结构视图，展示：
- 内部机构（百药堂、百锻堂等）
- 核心成员及其职位
- 点击成员打开人物卡片

**交互操作**：

| 操作 | 效果 |
|------|------|
| 悬浮节点 | 浮层：组织名、类型、成员数、据点数 |
| 点击节点 | 弹出组织卡片 |
| 双击节点 | 展开组织内部结构 |
| 悬浮边 | 显示关系详情：类型、建立章节、演变历史 |
| 点击边 | 弹出关系详情浮层 |

**筛选面板**：

| 筛选维度 | 选项 |
|----------|------|
| 组织类型 | 多选：门派 / 家族 / 国家 / 帮派 / 其他 |
| 关系类型 | 多选：盟友 / 敌对 / 从属 / 竞争 |
| 最少成员数 | 滑块：过滤小型组织 |

---

#### 3.3.5 视图联动

四个可视化视图之间支持联动：

- **人物关系图 → 世界地图**：在关系图中选择一个人物，世界地图自动叠加该人物的移动轨迹
- **时间线 → 阅读**：点击时间线上的事件节点，跳转到对应章节
- **势力图 → 人物关系图**：在势力图中点击组织，人物关系图自动筛选为该组织成员的关系网络
- **章节范围滑块**：四个视图共享同一个章节范围状态，在任一视图调整后其他视图同步更新

### 3.4 智能问答

用户可以用自然语言向系统提问关于小说的任何问题，系统基于知识图谱和原文检索给出答案。

#### 3.4.1 问答入口与交互模式

问答入口以**常驻迷你输入框**的形式出现在所有小说内页面的底部。用户也可以通过快捷键（Cmd/Ctrl + K）快速聚焦。

输入框内提供占位提示：

> 问任何关于这本小说的问题……

**两种交互模式**：

- **浮动面板模式**（默认）：用户在底部输入框开始输入或点击输入框时，一个对话面板从底部滑出，占据屏幕下方约 50% 的高度。用户可以在不离开当前页面（阅读/图谱等）的情况下快速提问和查看回答。面板可拖拽调整高度，点击面板外区域或按 Esc 收起。
- **全屏对话模式**：面板右上角提供"展开"按钮，点击后跳转到 `/novel/:id/chat` 全屏对话页面，适合长时间深度问答。全屏页面左侧有对话列表侧栏，方便管理多个对话。

两种模式**共享同一个对话上下文**——在浮动面板中的问答展开到全屏后对话连续，不会丢失。

#### 3.4.2 对话界面

问答以**对话流**的形式展开，保留上下文，支持连续追问：

> **用户**：韩立的师傅是谁？
>
> **系统**：韩立有两位师傅：
> 1. `墨大夫` — 在 `药园` 传授基础药理（第 3 章起），为韩立的启蒙恩师
> 2. `李化元` — 在 `七玄门内门` 指导修炼（第 25 章起），传授御剑术
>
> 来源：第 3、10、25、26 章
>
> **用户**：墨大夫后来怎么了？
>
> **系统**：`墨大夫` 在第 50 章 `七玄门` 遭 `魔道` 偷袭时，为掩护弟子撤退而阵亡。
>
> 来源：第 50 章

**答案中的交互**：
- 实体名（人物、地点、物品等）高亮显示，可点击弹出实体卡片
- 章节引用可点击跳转到阅读页面
- "来源"标注显示答案依据的原文章节，点击可展开原文片段

#### 3.4.3 答案生成规则

| 规则 | 说明 |
|------|------|
| 基于事实 | 答案必须基于小说原文和知识图谱，不编造内容 |
| 标注来源 | 每个答案附带来源章节，用户可验证 |
| 承认不知 | 如果知识图谱中没有足够信息，明确回答"根据已分析的内容，暂未找到相关信息"，而非猜测 |
| 分析范围提示 | 如果小说仅部分分析，答案末尾标注"基于已分析的 X 章内容" |
| 上下文连续 | 支持代词指代（"他后来呢？"能理解"他"指上文提到的人物） |

#### 3.4.4 问题类型与回答策略

| 问题类型 | 示例 | 回答策略 |
|----------|------|----------|
| 实体查询 | "韩立是谁？" | 返回人物卡片摘要（基本信息 + 核心关系） |
| 关系查询 | "韩立和墨大夫什么关系？" | 展示关系演变链 + 关键章节 |
| 事件查询 | "七玄门之战发生了什么？" | 按时间顺序叙述事件经过 + 涉及人物/地点 |
| 空间查询 | "药园在哪里？" | 展示地点层级链 + 周边地点 |
| 比较查询 | "韩立和厉飞雨谁更强？" | 对比两人的能力/境界 + 交手记录 |
| 统计查询 | "出场最多的角色是谁？" | 从统计数据中检索排名 |
| 推理查询 | "谁最可能是幕后黑手？" | 基于已知关系和事件链推理，标注推理过程 |
| 开放讨论 | "这本小说的主题是什么？" | 基于事件和人物弧光给出分析，标注为"系统分析"而非事实 |

#### 3.4.5 对话管理

| 功能 | 说明 |
|------|------|
| 对话历史 | 保留当前小说的对话记录，下次打开可继续 |
| 新建对话 | 用户可开始新对话，清空上下文 |
| 对话列表 | 全屏对话页侧边栏展示历史对话列表，可切换/删除 |
| 导出 | 支持将对话内容导出为 Markdown 文件 |

---

### 3.5 小说分析

上传小说后，系统需要对小说进行 AI 分析才能提取实体、关系、事件等结构化数据。分析是一个耗时的后台任务，需要清晰的进度管理。

#### 3.5.1 分析触发

上传小说后，系统自动完成章节切分并进入"待分析"状态。用户可以：

- **立即分析全书**：一次性分析所有章节（耗时较长）
- **按需分析**：先阅读，阅读到某一章时触发该章的分析（渐进式）
- **指定范围分析**：选择分析第 X 章到第 Y 章

分析过程中用户可以继续阅读已分析完成的章节。

#### 3.5.2 分析进度

分析过程中显示进度面板：

> **《凡人修仙传》 分析中……**
>
> ████████░░░░░░░░░░░░ 42%
>
> 当前：第 84 / 200 章
> 已提取：1,245 个实体 | 3,567 条关系 | 892 个事件
> 预计剩余：约 58 章待分析
>
> [ 暂停 ]　[ 取消 ]

**分析状态**：待分析 → 分析中 → 已完成 / 已暂停 / 已取消

**暂停与取消的区别**：

| 操作 | 已分析数据 | 后续操作 |
|------|-----------|----------|
| 暂停 | 保留 | 显示"恢复"按钮，从断点继续 |
| 取消 | 保留 | 分析任务终止。后续可以重新发起分析，系统跳过已分析的章节 |

两者的区别在于：暂停是临时中断（如需要释放系统资源），取消是放弃当前分析任务。已分析的数据在两种情况下都不会丢失。

#### 3.5.3 重新分析

用户可以对已分析的章节发起重新分析（如更换了模型、或对分析质量不满意）。操作路径：在分析页面选择章节范围 → 点击"重新分析"→ 确认覆盖已有数据。

#### 3.5.4 章节分析状态

在阅读页面的章节目录侧栏中，每个章节标注分析状态（卷标题行额外显示该卷的分析进度汇总，如"5/10 ✓"）：

| 标记 | 含义 |
|------|------|
| ● 绿色 | 已分析完成，实体高亮、卡片数据可用 |
| ● 黄色 | 分析中 |
| ● 红色 | 分析失败，可重试 |
| ○ 灰色 | 未分析，纯文本阅读模式 |

未分析的章节可正常阅读，但没有实体高亮和卡片数据。

---

### 3.6 书架管理

用户可能同时研究多本小说，需要一个书架来管理。

#### 3.6.1 书架页面

应用启动时默认进入书架页面，展示所有已导入的小说：

| 展示信息 | 说明 |
|----------|------|
| 封面 | 默认生成的封面（书名 + 作者），后续可考虑 AI 生成 |
| 书名 | 小说标题 |
| 作者 | 作者名（如果有） |
| 章节数 | 总章节数 |
| 分析进度 | 进度条：已分析章节 / 总章节 |
| 阅读进度 | "读到第 X 章" |
| 最后打开时间 | 上次阅读/操作的时间 |

默认按最后打开时间排序，支持按书名、章节数排序。

#### 3.6.2 书架操作

| 操作 | 说明 |
|------|------|
| 点击小说 | 进入该小说的阅读/分析界面 |
| 上传新书 | 点击"+"按钮，选择 .txt / .md 文件上传 |
| 删除小说 | 长按或右键菜单删除，需二次确认。删除同时清除该小说的所有分析数据 |
| 搜索 | 按书名/作者搜索 |

#### 3.6.3 首次使用引导

用户首次打开应用时，系统执行环境检测：

1. **检测 Ollama 状态**：是否已安装并运行
2. **检测模型**：是否已下载所需模型（如 qwen2.5:7b）
3. 如果检测不通过，显示引导页面，分步骤指导用户完成环境配置

环境就绪后，显示空书架页面，中央提示"上传你的第一本小说开始体验"+ 醒目的上传按钮。

---

### 3.7 百科

百科是小说知识的结构化索引，将分析过程中提取的所有实体和概念组织为可浏览、可搜索的知识库。

#### 3.7.1 百科页面

百科页面分为左侧分类导航和右侧内容区：

**左侧分类导航**：

```
全部 (1,892)
├── 人物 (456)
├── 地点 (238)
├── 物品 (312)
├── 组织 (89)
└── 概念 (797)
    ├── 修炼体系 (45)
    ├── 种族 (23)
    ├── 货币/资源 (18)
    ├── 功法/技能 (156)
    └── 其他 (555)
```

**右侧内容区**：

按类别展示词条列表。每个词条显示：名称、类型、简要定义（一行）、首次出现章节。支持按名称/首次出现章节排序。

顶部提供**搜索框**，支持按名称模糊搜索，实时过滤。

#### 3.7.2 概念词条

概念词条是百科的核心增量内容（人物/地点/物品/组织的详细信息已在实体卡片中覆盖，百科只提供索引入口）。

每个概念词条展示：

| 字段 | 说明 |
|------|------|
| 概念名称 | 如"筑基期" |
| 所属分类 | 如"修炼体系" |
| 定义 | 系统从原文中综合提炼的解释 |
| 首次提及 | 第 X 章 |
| 原文摘录 | 小说中关于该概念的典型描述（1-3 条，附章节出处） |
| 关联概念 | 同体系的相关概念（如"练气期"→"筑基期"→"结丹期"构成升级序列） |
| 关联实体 | 与该概念相关的人物/物品/地点 |

概念词条示例：

> **筑基期**
>
> 分类：修炼体系
>
> 修仙第二大境界。修士在练气期巅峰服用筑基丹或凭自身悟性突破后进入此境界，寿命可达数百年，实力远超练气期。筑基期分为初期、中期、后期三个小境界。
>
> 首次提及：第 5 章
>
> 原文摘录：
> - 第 23 章："筑基成功后，韩立只觉体内灵力暴涨数倍，感知范围扩大了不止一筹。"
> - 第 42 章："筑基丹可助练气期巅峰修士强行突破，但有三成失败风险。"
>
> 关联概念：练气期、结丹期、筑基丹
> 关联实体：`韩立`、`墨大夫`、`筑基丹`

点击百科中的人物/地点/物品/组织词条时，直接弹出对应的实体卡片（不单独设计百科版卡片）。

---

## 4. 功能清单

基于以上核心场景，按模块汇总所有功能，标注优先级。

P0 = 必须有（MVP），P1 = 应该有（发布后尽快补充），P2 = 可以有（后续迭代）

### 4.1 书架管理

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-01 | 上传小说 (.txt / .md) | P0 | 上传后自动切分章节，显示预览页，确认后导入书架 |
| F-02 | 书架列表展示 | P0 | 显示封面、书名、分析进度、阅读进度 |
| F-03 | 删除小说 | P0 | 二次确认后删除小说及全部关联数据 |
| F-04 | 书架搜索/排序 | P1 | 支持按书名搜索，按时间/书名排序 |
| F-05 | 重复上传检测 | P1 | 同名小说上传时显示对比面板，用户选择覆盖或新建 |
| F-06 | 章节切分调整 | P1 | 预览页支持切换切分模式、增删切分点 |

### 4.2 小说阅读

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-10 | 章节阅读 | P0 | 渲染章节文本，支持上下章翻页 |
| F-11 | 章节目录导航 | P0 | 侧边栏树形章节目录，支持卷>章多级折叠，点击跳转，标注分析进度和状态 |
| F-12 | 实体高亮 | P0 | 已分析章节中实体名按类别颜色高亮 |
| F-13 | 实体卡片弹出 | P0 | 点击高亮实体弹出对应卡片 |
| F-14 | 阅读进度记忆 | P0 | 记住每本书最后阅读的章节，下次打开自动恢复 |
| F-15 | 章节引用跳转 | P1 | 卡片/问答中的章节引用可点击跳转 |
| F-16 | 阅读设置 | P1 | 字号、行距、主题（亮/暗）调节 |
| F-17 | 全文搜索 | P1 | 在当前小说所有章节中搜索关键词，跳转到匹配位置 |

### 4.3 实体卡片

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-20 | 人物卡片 | P0 | 展示基本信息、关系、能力、经历等 7 个区块 |
| F-21 | 地点卡片 | P0 | 展示基本信息、空间层级、到访人物、事件等 6 个区块 |
| F-22 | 物品卡片 | P1 | 展示基本信息、持有流转、使用记录等 6 个区块 |
| F-23 | 组织卡片 | P1 | 展示基本信息、成员、据点、大事记等 7 个区块 |
| F-24 | 卡片内截断与展开 | P0 | 各区块按规则截断，支持展开/弹窗查看全部 |
| F-25 | 卡片间互相跳转 | P0 | 卡片内的实体名可点击跳转到对应卡片 |
| F-26 | 概念浮层 | P1 | 点击概念高亮弹出定义浮层 |

### 4.4 知识图谱可视化

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-30 | 人物关系图 | P0 | 力导向图展示人物关系，支持缩放/拖拽/筛选 |
| F-31 | 世界地图-空间视图 | P1 | 节点区域型空间地图，支持语义缩放(5级)和人物轨迹 |
| F-32 | 世界地图-层级视图 | P0 | 树状展示地点包含关系 |
| F-33 | 时间线 | P1 | 水平轴展示事件分布，支持多泳道模式 |
| F-34 | 势力图 | P2 | 组织关系网络图，支持展开内部结构 |
| F-35 | 章节范围滑块 | P0 | 全局滑块控制所有视图的数据范围 |
| F-36 | 视图联动 | P1 | 四个视图之间数据联动 |
| F-37 | 筛选面板 | P0 | 各视图支持按类型/属性筛选 |
| F-38 | 路径查找 | P1 | 在关系图中查找两人物间最短路径 |
| F-39 | 轨迹动画播放 | P2 | 空间地图上人物轨迹按章节动画播放 |
| F-40 | 手动调整地图布局 | P2 | 拖拽调整地点位置并持久化 |

### 4.5 智能问答

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-50 | 自然语言问答 | P0 | 输入问题，返回基于知识图谱的答案 |
| F-51 | 答案来源标注 | P0 | 每个答案标注来源章节，可点击查看原文 |
| F-52 | 答案中实体高亮 | P0 | 答案文本中的实体名高亮，可点击弹出卡片 |
| F-53 | 对话上下文 | P1 | 支持连续追问，理解代词指代 |
| F-54 | 浮动面板问答 | P0 | 底部常驻输入框，滑出浮动面板进行问答 |
| F-55 | 对话历史 | P1 | 保存/切换/删除历史对话 |
| F-56 | 对话导出 | P2 | 将对话导出为 Markdown |

### 4.6 小说分析

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-60 | 全书分析 | P0 | 一键触发全书分析，后台执行 |
| F-61 | 分析进度展示 | P0 | 显示进度条、当前章节、已提取实体/关系数 |
| F-62 | 暂停/恢复分析 | P0 | 暂停后保留已分析数据，可恢复继续 |
| F-63 | 取消分析 | P0 | 终止分析任务，已分析数据保留 |
| F-64 | 按范围分析 | P1 | 指定章节区间进行分析 |
| F-65 | 重新分析 | P1 | 对已分析章节重新分析并覆盖数据 |
| F-66 | 按需分析 | P2 | 阅读到未分析章节时自动触发该章分析 |

### 4.7 百科

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-70 | 百科页面 | P1 | 分类展示所有实体和概念，支持搜索和筛选 |
| F-71 | 概念词条 | P1 | 展示概念定义、原文摘录、关联概念/实体 |
| F-72 | 概念自动分类 | P1 | 系统自动将概念归类到修炼体系/种族/货币等分类 |

### 4.8 系统

| 编号 | 功能 | 优先级 | 验收标准 |
|------|------|--------|----------|
| F-80 | 首次使用引导 | P0 | 检测 Ollama 和模型状态，引导用户完成环境配置 |
| F-81 | 设置页面 | P1 | 阅读设置、LLM 配置、数据管理 |
| F-82 | 分析数据导出 | P1 | 将单本小说的分析数据导出为 JSON 文件 |
| F-83 | 分析数据导入 | P1 | 从 JSON 文件导入分析数据到另一台机器 |

---

## 5. 页面清单

| 页面 | 路径 | 用途 | 核心组件 |
|------|------|------|----------|
| 书架 | `/` | 应用首页，管理所有小说 | 小说卡片列表、上传按钮、搜索栏、首次引导 |
| 阅读 | `/novel/:id/read` | 阅读小说章节，查看实体高亮 | 章节文本区、章节目录侧栏（树形折叠）、实体卡片抽屉、概念浮层 |
| 关系图 | `/novel/:id/graph` | 人物关系力导向图 | 图谱画布、筛选面板、章节滑块 |
| 世界地图 | `/novel/:id/map` | 空间地图 + 层级地图 | 地图画布、视图切换标签、轨迹面板、筛选面板 |
| 时间线 | `/novel/:id/timeline` | 事件时间线 | 时间轴画布、泳道切换、筛选面板 |
| 势力图 | `/novel/:id/factions` | 组织关系网络 | 图谱画布、筛选面板 |
| 问答 | `/novel/:id/chat` | 智能对话问答（全屏模式） | 对话流、输入框、对话列表侧栏 |
| 百科 | `/novel/:id/encyclopedia` | 实体索引 + 概念词条 | 分类导航、词条列表、搜索框 |
| 分析 | `/novel/:id/analysis` | 分析进度和统计 | 进度面板、实体/关系统计、触发分析操作 |
| 设置 | `/settings` | 全局设置 | LLM 配置、阅读偏好、数据管理 |

**页面导航**：进入某本小说后，通过顶部标签栏在阅读/关系图/世界地图/时间线/势力图/百科/分析之间切换。问答输入框以常驻底栏形式出现在所有小说内页面（点击展开浮动面板，或展开到全屏对话页）。

---

## 6. 交互规则

### 6.1 全局交互规则

以下规则在整个应用中生效，适用于阅读页、卡片、问答、可视化等所有场景。

**章节引用可跳转**：文档中所有出现的章节引用（如"第 5 章"）均为可点击元素，点击后跳转到该章节的阅读页面。

**实体名可交互**：所有出现的实体名（人物、地点、物品、组织、概念）均为可点击元素，点击后弹出对应的实体卡片或概念浮层。实体名的颜色按类别统一编码：

| 实体类型 | 颜色 |
|----------|------|
| 人物 | 蓝色 |
| 地点 | 绿色 |
| 物品 | 橙色 |
| 组织 | 紫色 |
| 概念 | 灰色 |

### 6.2 实体卡片展示形态

实体卡片统一以**右侧抽屉（Drawer）**的形式展示：

| 属性 | 说明 |
|------|------|
| 位置 | 从屏幕右侧滑出 |
| 宽度 | 约 420px |
| 遮罩 | 半透明遮罩覆盖左侧内容，点击遮罩关闭卡片 |
| 关闭方式 | 点击遮罩 / 点击关闭按钮 / 按 Esc |

**卡片内跳转行为**：在人物卡片中点击另一个人物名时，抽屉内容**替换**为新人物的卡片（而非叠加新抽屉），顶部显示导航面包屑（如"韩立 > 墨大夫 > 张铁"），点击面包屑可回退。面包屑最多保留 10 层。

### 6.3 实体消歧

当同一个名称对应多个实体时（如小说中有两个"张三"），点击高亮名称弹出**消歧选择面板**：

> 选择你想查看的实体：
>
> **张三** — 七玄门弟子，出场 45 章
>
> **张三** — 越国商人，出场 3 章

用户选择后打开对应实体的卡片。系统在分析阶段根据上下文自动进行消歧，大多数情况下不需要用户手动选择。

### 6.4 部分分析提示

当小说仅完成部分章节分析时：

| 场景 | 处理方式 |
|------|----------|
| 实体卡片统计 | "出场 X 章"后标注"（基于已分析的 Y 章）" |
| 知识图谱/地图 | 仅展示已分析章节的数据，顶部提示"当前展示基于已分析的 X / Y 章数据" |
| 问答 | 回答末尾标注"基于已分析的 X 章内容"；涉及未分析章节的问题回答"该章节尚未分析" |
| 百科 | 同上，仅展示已分析章节中提取的概念和实体 |

### 6.5 加载状态

| 场景 | 处理方式 |
|------|----------|
| 页面加载 | 骨架屏 (Skeleton)，保持布局结构，内容区域显示灰色占位块 |
| 实体卡片加载 | 卡片框架立即出现，内容区域逐块加载（基本信息优先，经历/关系等异步填充） |
| 图谱/地图加载 | 先显示画布和控件框架，节点/边逐步渲染（避免空白等待） |
| 问答响应 | 流式输出，答案文字逐步显现（类似 ChatGPT），而非等待全部生成后一次性显示 |
| 分析进度 | 实时更新进度条和计数器（通过 WebSocket 推送） |

### 6.6 空状态

| 场景 | 展示 |
|------|------|
| 书架为空 | 居中提示"还没有导入小说"+ 上传按钮 |
| 小说未分析 | 章节文本正常显示，实体高亮区域提示"此章节尚未分析" + 分析按钮 |
| 图谱无数据 | 居中提示"暂无数据，请先分析小说" + 跳转分析页按钮 |
| 问答无历史 | 显示示例问题引导用户提问 |
| 卡片某区块为空 | 该区块显示"暂无数据"灰色文字，不隐藏区块标题 |
| 百科无数据 | 居中提示"请先分析小说以生成百科内容" |

### 6.7 错误处理

| 场景 | 处理方式 |
|------|----------|
| 上传格式错误 | 即时提示"仅支持 .txt / .md 格式" |
| 文件编码无法识别 | 提示"无法识别文件编码" + 手动选择编码的选项 |
| LLM 服务不可用 | 顶部全局通知栏提示"本地模型服务未启动" + 引导启动 Ollama 的说明 |
| 分析某章节失败 | 标记该章节为"分析失败"（红色），允许重试，不影响其他章节继续分析 |
| 问答生成失败 | 在对话中显示"生成失败，请重试"+ 重试按钮 |
| 本地服务/存储异常 | Toast 提示具体错误信息，3 秒后自动消失 |

### 6.8 通用交互约定

| 约定 | 说明 |
|------|------|
| 卡片/弹窗关闭 | 点击遮罩层或按 Esc 关闭 |
| 列表截断 | 所有列表超出默认显示数量时统一展示"共 X 项 ▸ 查看全部" |
| 快捷键 | Cmd/Ctrl + K：聚焦问答输入框；Esc：关闭弹窗/卡片；←/→：上下章节 |
| 响应式布局 | 主要支持桌面端（最小宽度 1024px），侧栏可折叠 |

---

## 7. 非功能需求

### 7.1 平台与部署

| 需求 | 说明 |
|------|------|
| 运行环境 | 本地部署，无需联网即可使用（模型和数据全部在本地） |
| 支持平台 | macOS 12.0+（Apple M1/M2/M3/M4），后续考虑 Linux/Windows |
| 前端形态 | Web 应用，浏览器访问（localhost），后续可考虑 Tauri 打包为桌面应用 |
| 后端框架 | Python (FastAPI)，复用 V1 成熟方案 |
| LLM 依赖 | Ollama 本地运行，支持 Qwen 2.5 系列模型。后续可扩展支持在线 LLM API |
| 浏览器兼容 | Chrome 100+ / Safari 16+ / Edge 100+（需支持 WebSocket、WebGL、CSS Grid） |

### 7.2 性能目标

| 指标 | M1 16GB 目标 | M1 8GB 目标 |
|------|-------------|-------------|
| 章节分析速度 | ≤ 30 秒/章 | ≤ 50 秒/章（可使用更小模型如 qwen2.5:3b） |
| 问答响应首字 | ≤ 3 秒（流式输出） | ≤ 5 秒 |
| 阅读页加载 | ≤ 1 秒（章节切换） | ≤ 1 秒 |
| 图谱渲染 | ≤ 3 秒（500 节点流畅） | ≤ 3 秒（300 节点流畅） |
| 空间地图渲染 | ≤ 5 秒（200 地点流畅） | ≤ 5 秒（100 地点流畅） |
| 内存占用 | ≤ 12 GB（含模型） | ≤ 7 GB（含模型） |

8GB 设备功能完整可用，但建议使用较小的模型以保证流畅度。设置页面中提供模型选择，并标注各模型的推荐配置。

### 7.3 数据存储

| 需求 | 说明 |
|------|------|
| 持久化 | 所有数据本地存储，应用关闭后数据不丢失 |
| 数据隔离 | 每本小说的数据独立存储，互不影响 |
| 导入导出 | 支持导出单本小说的分析数据（JSON），可在另一台机器导入恢复 |
| 存储空间 | 单本小说分析数据预估 50-500 MB（取决于章节数） |

### 7.4 隐私

| 需求 | 说明 |
|------|------|
| 完全本地 | 不向任何外部服务器发送用户数据或小说内容 |
| 无遥测 | 不收集任何使用数据 |

---

## 8. 不做什么

以下功能明确排除在 V2 范围之外：

| 不做 | 原因 |
|------|------|
| 多用户/账号系统 | 定位为本地单用户工具 |
| 云端同步 | 隐私优先，所有数据本地存储 |
| 在线协作 | 单用户场景 |
| 小说编辑/写作 | 定位是"研究阅读"工具，不是写作工具 |
| 电子书格式 (epub/mobi/pdf) | V2 只支持 .txt 和 .md，其他格式后续迭代 |
| 多语言小说支持 | V2 专注中文小说，英文等后续迭代 |
| AI 生成人物画像 | V2 使用占位头像，图像生成后续迭代 |
| 移动端适配 | V2 只做桌面端 Web |
| Tile 地图编辑器 | 世界地图是节点-区域示意图，不是游戏 tile 地图 |
| 实时多人问答 | 单用户本地问答 |
| V1 数据迁移 | 新仓库新架构，V1 数据不兼容 |
| 防剧透系统 | 本产品定位为研究工具，用户需要全局视角；仅保留简单的阅读位置记忆 |
| 手动实体编辑/合并 | V2 不提供用户手动编辑实体数据的功能，分析结果由系统生成。后续迭代考虑 |
