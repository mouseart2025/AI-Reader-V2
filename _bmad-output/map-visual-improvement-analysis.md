# 世界地图视觉效果分析与改进方案

> 🏗️ Architect Agent (Winston) | 2026-02-23
>
> 分析对象：NovelMap.tsx (D3+SVG 奇幻地图渲染) + map_layout_service.py (布局引擎)

---

## 一、问题识别

### 问题 1：不同尺度地点的视觉区分不足

**现象**：从 continent 到 building 六级地点，视觉差异主要靠图标尺寸（32→14px）和字号（22→9px）。缩放后反缩放机制抵消了大小差异——所有节点在屏幕上维持恒定像素大小，continent 和 building 看起来几乎一样。

**对比参照**：真实地图（Google Maps）和经典奇幻地图（中土世界、冰与火之歌）中，不同尺度的地标有完全不同的视觉语言——国家是面域填充+粗体大字，城市是圆点+小字，村庄只在高缩放出现。

**根因分析**：

| 根因 | 类型 | 层 |
|-------|------|---|
| 反缩放使所有节点保持恒定屏幕大小，消除了层级的视觉权重差异 | 设计决策 | 前端 |
| 6 级仅用线性尺寸区分（32/28/24/20/16/14），比值仅 2.3:1 | 参数问题 | 前端 |
| 图标全部是同质化的简单形状（circle/path），缺乏层级特有的视觉形态 | 设计问题 | 资源 |
| 颜色由 type 关键词决定，与 tier 无关——"元化国"和"青牛镇"可能同色 | 设计缺失 | 前端 |

### 问题 2：父子包含关系视觉表达薄弱

**现象**：区域（territory）用 Voronoi 边界虚线表达，但——

1. territory 是扁平的 Voronoi 切分，不体现嵌套包含（国→城→门派→殿堂的层层嵌套在视觉上丢失）
2. territory 边界只显示到 level 2（密集时只显示 level 0），中间层级缺失
3. territory 填充色是半透明的均匀色块，无法直觉传达"黄枫谷在越国之内"
4. 约束求解的 `PARENT_RADIUS = 120px` 是固定值，不随 tier 变化——continent 的"包含半径"和 city 的一样大

**根因分析**：

| 根因 | 类型 | 层 |
|-------|------|---|
| Voronoi 细分是空间分割而非嵌套包含，天然无法表达层级嵌套 | 算法限制 | 前端 |
| PARENT_RADIUS 是固定 120px，未按父级 tier 分级（continent 应远大于 city） | 参数问题 | 后端 |
| 布局引擎对子节点的放置半径（child_radius）以 0.6 比例递减，但初始值偏小（radius*0.5） | 参数问题 | 后端 |
| territory 密度管理粗暴截断（>15 只显示 level 0），无渐进式简化 | 实现问题 | 前端 |

### 问题 3：整体"地图感"不足

**现象**：当前地图更像一张"节点 + 边界线"的信息图，而非让人联想到古地图/奇幻地图的沉浸式视图。

**参照**：经典奇幻地图特征——

| 特征 | 当前实现 | 差距 |
|-------|---------|------|
| 羊皮纸质感 | feTurbulence 纹理（opacity 0.04，极淡） | 几乎不可见 |
| 手绘边界线 | feTurbulence+feDisplacementMap（scale=2，极弱） | 肉眼无感 |
| 地形暗示（山脉、河流、海岸线） | ❌ 地形图层被注释禁用 | 完全缺失 |
| 装饰性元素（罗盘、海怪、卷轴边框） | ❌ | 完全缺失 |
| 路径/道路连线 | 仅轨迹回放线（amber色） | 无永久性路网 |
| 水域/海洋表达 | 无 | 缺失 |
| 文字排版（弯曲沿路径、大区域名称居中大字） | 区域名称仅水平居中 | 单调 |

**根因分析**：

| 根因 | 类型 | 层 |
|-------|------|---|
| 地形底图（terrain.png）因与 territory 视觉冲突被禁用 | 取舍决策 | 前端 |
| 手绘滤镜参数过弱（scale=2），无视觉效果 | 参数问题 | 前端 |
| 羊皮纸纹理 opacity=0.04 太淡 | 参数问题 | 前端 |
| SVG 图标过于简约（仅 fill white 的基础形状），缺乏手绘/古地图风格 | 资源问题 | 资源 |
| 缺少地形语义层（山脉→三角形纹理、河流→曲线、海洋→波浪纹） | 功能缺失 | 前端+后端 |

### 问题 4：大量地点时的信息过载

**现象**：400+ 地点时——

1. overview-dots 层产生密集点云，无法分辨个体
2. 标签碰撞检测虽然工作，但大量标签被隐藏，用户不知道哪些被隐藏了
3. 缩放到 site/building 级别时标签突然批量出现，视觉跳变
4. 约束求解只处理 top 40 地点，其余 360+ 地点用 sunflower/hash 随机放置，布局质量骤降

**根因分析**：

| 根因 | 类型 | 层 |
|-------|------|---|
| MAX_SOLVER_LOCATIONS=40 的硬上限，多出的地点布局质量无保证 | 性能取舍 | 后端 |
| 缩放阈值硬切换（display:none ↔ display:block），无渐变过渡 | 实现问题 | 前端 |
| 缺少聚类/聚合机制——密集区域的小地点应合并显示 | 功能缺失 | 前端+后端 |
| overview-dots 是固定 3px 圆点，不按密度/重要度调整 | 参数问题 | 前端 |

### 问题 5：暗色层（天界/冥界/海底）视觉单调

**现象**：非 overworld 层使用纯深色背景（#0f172a/#1a0a2e），无纹理/星空/岩浆等氛围。节点颜色在深色背景上辨识度下降。

**根因**：暗色层缺少专属视觉主题（如天界→星云纹理、冥界→幽暗雾气）。

---

## 二、改进方案

### 🟢 Quick Wins（调参 + 样式微调，不改架构）

#### Q1: 增强羊皮纸质感

**改动文件**：`NovelMap.tsx`

- 将 parchment-noise opacity 从 `0.04` 提升到 `0.08~0.12`
- 增加一层低频大尺度 feTurbulence（baseFrequency=0.005，numOctaves=2），模拟纸张大面积不均匀
- 暗角 vignette 加深：rgba(120,90,50,**0.28**) → 目前 0.18 太淡

#### Q2: 增强手绘边界效果

**改动文件**：`NovelMap.tsx` / `edgeDistortion.ts`

- `hand-drawn` filter 的 `scale` 从 2 提升到 **5~8**
- `edgeDistortion.ts` 的 `amplitude` 从 `canvasMin * 0.01` 提升到 **0.015~0.02**
- territory 边界 stroke-width 加粗（level 0: 2.5→**3.5**，level 1: 1.8→**2.5**）

#### Q3: 扩大 tier 视觉差异

**改动文件**：`NovelMap.tsx`

- 拉大 TIER_ICON_SIZE 比例：continent **40**→kingdom **30**→region 24→city 18→site **14**→building **10** （比值变为 4:1）
- 拉大 TIER_TEXT_SIZE：continent **26**→kingdom **20**→region 14→city 11→site **9**→building **8**
- continent/kingdom 文字加粗（font-weight: 700），其余保持 400
- continent/kingdom 标签增加阴影（SVG feDropShadow 或 text-shadow stroke 加宽）

#### Q4: 缩放级别渐变过渡

**改动文件**：`NovelMap.tsx`

- 将 tier 的 `display: none/block` 硬切换改为 opacity 渐变：

```
opacity = clamp((scale - minScale) / (minScale * 0.3), 0, 1)
```

- 使图标和标签在接近阈值时 fade in/out 而非突然出现

#### Q5: overview-dots 按重要度分级

**改动文件**：`NovelMap.tsx`

- dot radius 按 tier 分级：continent=5, kingdom=4, region=3.5, city=3, site=2.5, building=2
- dot opacity 按 mention_count 调整：高频地点更亮

#### Q6: PARENT_RADIUS 按 tier 分级

**改动文件**：`map_layout_service.py`

```python
PARENT_RADIUS_BY_TIER = {
    "continent": 300,
    "kingdom": 200,
    "region": 150,
    "city": 100,
    "site": 60,
    "building": 40,
}
```

使约束求解中的包含半径反映真实空间尺度。

---

### 🟡 Medium Effort（新增组件/逻辑，不重构核心）

#### M1: 层级嵌套区域边界（替代 Voronoi） ✅ (v0.25.2)

**思路**：为有子节点的地点绘制 **convex hull + padding** 作为包含区域，替代当前 Voronoi 空间分割。

**实现**：
- 后端：对每个 parent，收集所有后代的坐标，计算 convex hull，按 tier 层级外扩不同 padding（continent +80px, kingdom +50px, city +30px）
- 前端：按 level 从外到内渲染嵌套的 hull 多边形
  - 边界样式随 level 递变：外层粗虚线→内层细虚线
  - 填充颜色随 level 递变（外层浅→内层略深）
  - 最内层不绘制 hull（只有图标）

**改动文件**：
- `map_layout_service.py`（新增 hull 计算，嵌套 padding 逻辑）
- `NovelMap.tsx`（新增 hull 渲染层替代 territory）
- 可移除 `territoryGenerator.ts` 的 Voronoi 逻辑

**视觉效果**：

```
┌──────────────── 越国 (粗虚线) ────────────────┐
│                                                │
│   ┌─── 黄枫谷 (细虚线) ───┐                    │
│   │  🏘 百药园  🏘 试炼之地  │   ⭐ 元化城       │
│   │  🏘 药园                │                   │
│   └────────────────────────┘                    │
│                                                │
│   ⭐ 越国皇城                                   │
└────────────────────────────────────────────────┘
```

#### M2: 地形语义纹理层 ✅ (v0.25.3)

**思路**：不用 terrain.png 位图，改用 SVG 纹理 pattern 为不同地点类型添加暗示性地形背景。

**已实现** (`terrainHints.ts` + `NovelMap.tsx`)：
- 5 类地形：mountain/water/forest/desert/cave，每类 2-3 个变体（含集群变体：山脉连峰/树丛/三重波浪）
- 按 tier 分级的符号数量（continent 22 → building 3）、散布半径（160→24px）和基础尺寸（38→12px）
- 确定性伪随机放置（sin-hash），√ 极坐标分布避免中心聚集
- 碰撞过滤（< 18px 跳过）+ 画布边界裁剪
- 亮色/暗色背景自适应配色，opacity 0.11-0.22
- 渲染到 `#terrain` SVG 层（z-order 在 regions/territories 之下）
- 全局上限 MAX_HINTS=900

#### M3: 区域名称弯曲文字

**思路**：大区域名称沿 path 弯曲排列，或按区域轮廓方向旋转，体现地图美感。

**实现**：
- 对 region-labels，使用 SVG `<textPath>` 沿一条微弧线路径绘制文字
- 弧线方向根据区域在画布中的位置决定（上方向下弯、下方向上弯）
- 字间距（letter-spacing）根据区域面积自适应

**改动文件**：`NovelMap.tsx`（修改 region-labels 渲染）

#### M4: 暗色层专属主题

**思路**：为不同层类型添加专属背景纹理和氛围效果。

| 层 | 背景效果 |
|----|---------|
| sky | 星空 pattern（随机小白点 + 大亮星 + 淡蓝色径向光晕） |
| underground | 岩石纹理 + 幽暗绿色雾气径向渐变 |
| sea | 深蓝渐变 + 波浪纹 pattern + 气泡散点 |
| pocket | 虫洞/漩涡径向渐变 |
| spirit | 紫色雾气 + 灵魂火焰散点 |

**实现**：每种层的 SVG 背景 pattern/filter 预定义，在 SVG defs 中，按 layerType 选择。

**改动文件**：`NovelMap.tsx`（新增各层背景 pattern/filter）

#### M5: 小地图 + 视口指示器

**思路**：在地图右下角添加缩略全图（minimap），当前视口用矩形框标出，帮助用户在大地图中定位。

**实现**：
- 独立 `<svg>` 绘制全部地点为小圆点
- 矩形框反映当前 d3-zoom 的视口范围
- 点击 minimap 可跳转到对应区域

**改动文件**：`NovelMap.tsx`（新增 minimap overlay 组件）

#### M6: 密集区域聚类标注

**思路**：低缩放级别下，密集区域的小地点用一个聚合标记表示（如 "+12 地点"），点击展开或缩放进入。

**实现**：
- 在缩放阈值以下，计算地点的 DBSCAN 聚类
- 聚类用 cluster marker 显示（带数字的圆形 badge）
- 点击 cluster marker 触发 zoom-to-fit 该区域

**改动文件**：
- `NovelMap.tsx`（新增聚类层 + 交互）
- 可选后端辅助计算聚类

---

### 🔴 Major Upgrades（核心重构，大工作量）

#### X1: WebGL / Canvas 渲染引擎

**现状问题**：SVG 在 400+ 节点时 DOM 元素过多（每个节点 3-5 个元素 + 标签 + 区域边界 → 2000+ DOM 节点），缩放/平移时重排成本高。

**方案**：迁移到 WebGL（via PixiJS / deck.gl）或 Canvas 2D 渲染，保留 D3 的数据绑定和缩放行为。

**收益**：
- 支持 1000+ 地点无性能问题
- 支持 GPU 加速的粒子特效（星空/雾气/波浪）
- 支持更复杂的地形渲染

**代价**：完全重写 NovelMap.tsx，需要新的交互机制（hit testing 替代 DOM 事件）。

#### X2: 二级约束求解（分治法）

**现状问题**：MAX_SOLVER_LOCATIONS=40 的限制使大部分地点布局质量低。

**方案**：
1. 第一级：对顶层区域求解宏观位置（10-15 个区域）
2. 第二级：在每个区域的 bounding box 内，对该区域的子地点做局部约束求解

**收益**：所有地点都能享受约束求解的质量，而非仅 top 40。

**代价**：重写 ConstraintSolver 为递归分治结构，需要重新设计能量函数的区域间/区域内权重。

#### X3: 程序化地图绘制风格（Fantasy Map Generator 风格）

**参考**：[Azgaar Fantasy Map Generator](https://azgaar.github.io/Fantasy-Map-Generator/)

**方案**：
- 基于高度图 + 水系生成 + 生物群落 + 地形着色的完整地图生成管线
- 地点位置约束在生成的地形上（城市在平原、渔村在海岸、山寨在山区）
- 需要后端生成完整的地理特征数据（海岸线、山脉走向、河流路径）

**收益**：从"信息图"质变为"沉浸式奇幻地图"。

**代价**：相当于构建一个独立的 FMG 系统，复杂度极高。

---

## 三、推荐优先级

基于 **用户价值 / 工程投入比** 排序：

| 优先级 | 方案 | 核心价值 | 预估工作量 |
|--------|------|---------|-----------|
| P0 | **Q3** 扩大 tier 视觉差异 | 最基础的层级区分 | 0.5h |
| P0 | **Q6** PARENT_RADIUS 按 tier 分级 | 修正包含关系的物理约束 | 1h |
| P0 | **Q4** 缩放渐变过渡 | 消除突变的 UX 痛点 | 1h |
| P1 | **Q1** 增强羊皮纸质感 | 最小代价提升氛围感 | 0.5h |
| P1 | **Q2** 增强手绘边界 | 配合 Q1 增强地图感 | 0.5h |
| P1 | **Q5** overview-dots 分级 | 减少视觉噪声 | 0.5h |
| ~~P2~~ | ~~**M1** 嵌套 hull 区域边界~~ | ~~解决核心的层级可视化问题~~ | ✅ v0.25.2 |
| ~~P2~~ | ~~**M2** 地形语义纹理~~ | ~~显著提升地图美感~~ | ✅ v0.25.3 |
| P3 | **M4** 暗色层主题 | 提升非 overworld 层体验 | 3-4h |
| P3 | **M3** 弯曲区域文字 | 细节美感提升 | 2-3h |
| P3 | **M5** 小地图 | 大地图导航辅助 | 3-4h |
| P4 | **M6** 密集聚类 | 解决 400+ 地点的信息过载 | 4-6h |
| P5 | **X2** 分治约束求解 | 解决大量地点布局质量 | 16-24h |
| P6 | **X1** WebGL 渲染 | 性能+特效上限提升 | 40-60h |
| P7 | **X3** FMG 风格 | 终极视觉体验 | 100h+ |

## 四、建议实施路线

### 第一阶段：Quick Wins 全部落地 (Q1-Q6)

预期效果：不改架构，通过参数调优和样式增强，让地图从"信息图"升级为"有基本美感的地图"。tier 之间的视觉区分度显著改善，包含约束更合理，缩放体验更平滑。

### 第二阶段：M1 嵌套 Hull + M2 地形纹理

这两个中等工作量的改进能带来最大的视觉质变：
- M1 解决了"看不出层级嵌套"的核心问题
- M2 让空白画布变成有地理感的地图

### 第三阶段：按需选择 M3-M6

根据用户反馈和实际需求优先级决定。M4（暗色层主题）如果暗色层使用频率高就优先；M5（小地图）如果大地图导航是痛点就优先。

### 远期：X2 分治求解 → X1 WebGL

当地点规模持续增长到需要支撑 500~1000 级别时再考虑。

---

## 五、关键设计决策记录

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 层级表达：Voronoi 分割 vs Convex Hull 嵌套 | **Hull 嵌套**（M1） | Voronoi 是空间分割，无法表达嵌套；hull 天然支持多级嵌套 |
| 地形表达：位图 terrain.png vs SVG 纹理 pattern | **SVG pattern**（M2） | 位图与 territory 冲突（已被禁用）；SVG pattern 可精确控制 opacity 和交互 |
| 反缩放策略：全反缩放 vs 混合 | **保持反缩放，但增大 tier 差异** | 完全取消反缩放会导致高缩放时节点消失，折中方案是保持反缩放但扩大 tier 间的固有差距 |
| 性能策略：SVG vs WebGL | **短期保持 SVG**（加上聚类优化） | SVG 在 400 以下够用，WebGL 迁移代价过高，优先用聚类缓解密度问题 |
