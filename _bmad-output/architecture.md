---
stepsCompleted: [1, 2]
inputDocuments:
  - PRD.md
  - interaction-design/01-bookshelf.excalidraw
  - interaction-design/02-reading.excalidraw
  - interaction-design/03-graph.excalidraw
  - interaction-design/04-map.excalidraw
  - interaction-design/05-timeline.excalidraw
  - interaction-design/06-factions.excalidraw
  - interaction-design/07-chat.excalidraw
  - interaction-design/08-encyclopedia.excalidraw
  - interaction-design/09-analysis.excalidraw
  - interaction-design/10-settings.excalidraw
  - (ref) ai-reader/docs/CURRENT_SYSTEM_ARCHITECTURE.md
workflowType: 'architecture'
project_name: 'AI-Reader-V2'
user_name: 'leonfeng'
date: '2026-02-11'
---

# AI Reader V2 架构决策文档

_本文档通过逐步协作发现构建。各章节在完成每个架构决策后追加。_

---

## 1. 项目上下文分析

### 1.1 需求概览

PRD 定义了 **83 个功能项**（F-01 到 F-83），按 8 个模块组织：

| 模块 | P0 | P1 | P2 | 架构影响 |
|------|----|----|----|----|
| 书架管理 (F-01~06) | 3 | 3 | 0 | 文件解析、编码检测、章节切分引擎 |
| 小说阅读 (F-10~17) | 5 | 3 | 0 | 实体高亮渲染、实体卡片系统、阅读状态管理 |
| 实体卡片 (F-20~26) | 4 | 3 | 0 | 复杂数据聚合（7 种区块）、卡片间导航栈 |
| 知识图谱可视化 (F-30~40) | 4 | 4 | 3 | 4 种可视化引擎、视图联动、章节范围滑块共享状态 |
| 智能问答 (F-50~56) | 4 | 2 | 1 | 流式 LLM 输出、WebSocket、对话上下文管理 |
| 小说分析 (F-60~66) | 4 | 2 | 1 | 后台长任务、进度推送、断点续传 |
| 百科 (F-70~72) | 0 | 3 | 0 | 分类索引、全文搜索 |
| 系统 (F-80~83) | 1 | 3 | 0 | 环境检测、配置管理、数据导入导出 |

### 1.2 非功能需求核心约束

1. **完全本地部署** — 无网络依赖，所有数据和模型在本地
2. **Apple Silicon 优化** — M1/M2/M3/M4，MPS 加速
3. **内存约束** — 8GB 最低可用，需 ≤ 7GB（含模型）
4. **性能目标** — 章节切换 ≤ 1s，问答首字 ≤ 3s，图谱 500 节点流畅
5. **仅中文** — 规则、提示词和 NLP 处理均为中文
6. **隐私** — 无遥测、无外部请求

### 1.3 复杂度评估

- 项目复杂度：**高**
- 主要技术领域：**全栈 (Full-stack Web + AI/NLP + 数据可视化)**
- 预估架构组件：**~25 个**

### 1.4 关键架构挑战

1. **4 种异构可视化引擎** — 力导向图、节点区域空间地图（Canvas）、时间线、势力网络图，需要统一的数据接口和章节范围联动机制
2. **复合实体卡片系统** — 4 种实体卡片 + 概念浮层，7 种数据区块，卡片间导航栈（面包屑）、消歧选择
3. **LLM 分析流水线** — V1 的 10 步流水线需重构为可暂停/恢复/部分重试的任务系统
4. **混合存储统一** — V1 有 7 个重叠 Store（已知痛点），V2 需统一为清晰的存储模型
5. **实时进度推送** — 分析进度、流式问答都需要 WebSocket，且前后端需协调
6. **世界地图语义缩放** — 5 级缩放 + 区域渲染 + 人物轨迹动画，Canvas 性能要求高

### 1.5 跨领域关注点

- **章节范围状态** — 4 个可视化视图 + 时间线 + 筛选面板共享同一章节范围
- **实体系统** — 5 种实体类型的颜色编码、高亮、卡片弹出贯穿所有页面
- **部分分析提示** — 所有页面需处理"仅部分章节已分析"的降级状态
- **加载状态** — 骨架屏、逐步渲染、流式输出各有不同策略
- **错误处理** — LLM 不可用、分析失败等需要全局通知机制

### 1.6 与 V1 的关系

V2 是**新仓库新架构**。V1 的存储设计（7 个 Store）、紧耦合流水线和扁平化数据模型不适合 V2 需求，需全面重新设计。V1 在空间关系规则抽取方面的积累（120+ 正则模式）可作为参考，但不直接复用代码。

---

## 2. 核心架构决策：章节级结构化事实抽取

### 2.1 决策背景

V1 的抽取系统存在根本性的模型-需求不匹配：

**V1 的扁平化抽取模型：**

- 实体抽取：LLM 逐章提取实体名+类型，每章限 2000 字符，章节间无上下文
- 关系抽取：在实体列表上二次调用 LLM，每章限 20 个实体，12 种固定关系类型
- 质量保障：300+ 停用词、50+ 正则模式、硬编码后缀列表（规则比主逻辑更复杂）
- 结果：扁平的 `Entity(name, type, confidence)` 和 `Relation(source, type, target)`

**V2 PRD 需要的数据：**

| 数据类型 | V1 能力 | V2 需求 |
|---------|---------|---------|
| 关系演变链（师徒→友人→仇人，每步有章节） | 无 | 必须 |
| 物品流转链（炼制→赠予→使用→消耗） | 无 | 必须 |
| 能力成长线（练气→筑基→结丹） | 无 | 必须 |
| 外貌变化（按章节记录） | 无 | 必须 |
| 人物经历（每章：在哪+和谁+做了什么） | 无 | 必须 |
| 组织成员变动（加入→晋升→离开） | 无 | 必须 |
| 概念定义和分类 | 仅有 Concept 类型标记 | 需要定义+分类+关联 |
| 地点空间层级 | 部分（规则提取） | 必须 |

**V1 能力覆盖率约 20%。**

### 2.2 决策：采用章节级结构化事实抽取（ChapterFact）

**核心思路转变：**

| 维度 | V1 | V2 决策 |
|------|----|----|
| 抽取单位 | "这本书有哪些实体/关系" | "这一章发生了什么事实" |
| 数据模型 | 扁平实体 + 扁平关系 | **ChapterFact（章节事实）** |
| 聚合方式 | 无 | ChapterFact → 聚合为实体档案 |
| LLM 调用/章 | 2 次（先实体、后关系） | **1 次**（统一提取） |
| 上下文 | 无（章节隔离） | 携带前序章节的实体状态摘要 |
| 关系类型 | 12 种固定枚举 | 自由文本，聚合层归类 |
| 增量更新 | 不支持 | 天然支持（重新抽取单章即可） |
| 错误恢复 | 不支持 | 天然支持（每章独立，失败可重试） |

### 2.3 ChapterFact 数据模型

每章产出一个 ChapterFact 结构，包含该章的全部结构化事实：

```
ChapterFact {
  chapter_id: int
  novel_id: str

  // ── 人物 ──────────────────────────────
  characters: [{
    name: str                       // 主要名称
    new_aliases: [str]              // 本章新出现的别称
    appearance: str | null          // 本章的外貌描写（仅当有描写时）
    abilities_gained: [{            // 本章获得/提升的能力
      dimension: str                //   "境界" / "技能" / "身份"
      name: str                     //   "练气三层" / "火球术" / "外门弟子"
      description: str              //   简要说明
    }]
    locations_in_chapter: [str]     // 本章到过的地点
  }]

  // ── 人物关系 ──────────────────────────
  relationships: [{
    person_a: str
    person_b: str
    relation_type: str              // 自由文本，如"师徒"、"同门"、"仇人"
    is_new: bool                    // 是否首次建立
    previous_type: str | null       // 如果关系变化，旧关系是什么
    evidence: str                   // 原文依据（1-2 句）
  }]

  // ── 地点 ──────────────────────────────
  locations: [{
    name: str
    type: str                       // 国家/城市/山脉/门派/建筑/房间/...
    parent: str | null              // 上级地点（如"药园"的 parent 是"七玄门"）
    description: str | null         // 本章的环境描写（仅当有描写时）
  }]

  // ── 物品事件 ──────────────────────────
  item_events: [{
    item_name: str
    item_type: str                  // 武器/丹药/法宝/材料/书籍/...
    action: str                     // 出现/获得/使用/赠予/消耗/丢失/损毁
    actor: str                      // 动作执行者
    recipient: str | null           // 接收者（赠予时）
    description: str | null         // 简要说明
  }]

  // ── 组织变动 ──────────────────────────
  org_events: [{
    org_name: str
    org_type: str                   // 门派/家族/势力/国家/...
    member: str | null              // 涉及成员
    role: str | null                // 职位/身份
    action: str                     // 加入/离开/晋升/阵亡/叛出/逐出
    description: str | null
    org_relation: {                 // 组织间关系变化（如有）
      other_org: str
      type: str                     // 盟友/敌对/从属/竞争
    } | null
  }]

  // ── 事件 ──────────────────────────────
  events: [{
    summary: str                    // 一句话概要
    type: str                       // 战斗/成长/社交/旅行/其他
    importance: str                 // high / medium / low
    participants: [str]             // 涉及人物
    location: str | null            // 发生地点
  }]

  // ── 新概念 ──────────────────────────
  new_concepts: [{
    name: str
    category: str                   // 修炼体系/种族/货币/功法/...
    definition: str                 // 从原文提炼的解释
    related: [str]                  // 关联概念
  }]
}
```

### 2.4 聚合层：ChapterFact → 实体档案

ChapterFact 是原始数据层。上层通过聚合产出 PRD 所需的实体档案：

```
全部 ChapterFact
  │
  ├── 按人物名聚合 → PersonProfile
  │   ├── 合并 aliases（按首次出现章节排序）
  │   ├── 收集 appearance 列表（按章节排序，展示外貌变化）
  │   ├── 收集 abilities_gained（按章节排序、按维度分组）
  │   ├── 从 relationships 构建关系演变链
  │   │   例: 韩立↔墨大夫: 初见(ch3) → 师徒(ch3) → 朋友(ch16) → 怀念(ch50)
  │   ├── 从 item_events 构建物品关联和流转
  │   ├── 从 events 构建人物经历（每章概要）
  │   └── 统计：出场章节数、首末出场、关联人物数...
  │
  ├── 按地点名聚合 → LocationProfile
  │   ├── 构建空间层级树（parent-child）
  │   ├── 收集 description 列表（按章节排序）
  │   ├── 反向聚合到访人物（从 characters.locations_in_chapter）
  │   │   区分常驻（出现 N 章以上）和到访
  │   ├── 从 events 构建地点事件
  │   └── 统计
  │
  ├── 按物品名聚合 → ItemProfile
  │   ├── 从 item_events 构建持有流转链
  │   │   例: 墨大夫 炼制(ch38) → 赠予 韩立(ch40) → 韩立 服用(ch45, 已消耗)
  │   ├── 收集 description（按章节排序）
  │   ├── 关联物品（共同出现在同一 item_events 中的其他物品）
  │   └── 统计
  │
  ├── 按组织名聚合 → OrgProfile
  │   ├── 从 org_events 构建成员变动历史
  │   ├── 构建组织层级和组织间关系
  │   ├── 从 locations 关联据点/领地
  │   └── 统计
  │
  ├── events 按章节汇总 → Timeline
  │
  └── new_concepts 汇总 → Encyclopedia（按 category 分类）
```

### 2.5 LLM 调用策略

**每章一次 LLM 调用，携带前序上下文：**

```
┌─────────────────────────────────────────────┐
│ System Prompt                                │
│ - 角色：小说分析专家                           │
│ - 规则：仅抽取文本明确提及的事实，不推测         │
│ - 输出：严格按 ChapterFact JSON Schema        │
├─────────────────────────────────────────────┤
│ Context（前序状态摘要，自动从已分析章节生成）     │
│ - 已知人物：韩立（药园学徒）、墨大夫（管事）...  │
│ - 已知关系：韩立↔墨大夫(师徒)、韩立↔张铁(同门)  │
│ - 已知地点：七玄门 > 药园、练功房...             │
│ - 已知物品：小绿瓶（韩立持有）...               │
├─────────────────────────────────────────────┤
│ Chapter Text（完整章节文本，不截断）             │
│ Qwen 2.5 7B 上下文窗口 128K，足够处理完整章节   │
├─────────────────────────────────────────────┤
│ Output: ChapterFact JSON                     │
└─────────────────────────────────────────────┘
```

**前序状态摘要的生成规则：**

- 从已完成的 ChapterFact 中自动聚合
- 只包含活跃实体（最近 N 章出现过的人物/地点/物品）
- 控制在 2000 token 以内，避免挤压章节文本的空间
- 随着章节推进，旧的非活跃实体逐步淡出摘要

### 2.6 质量保障策略

**不再依赖规则堆积，改为分层保障：**

| 层级 | 策略 | 说明 |
|------|------|------|
| Schema 约束 | JSON Schema 强制格式 | Qwen 2.5 原生支持 structured output |
| Few-shot 示例 | Prompt 中包含 1-2 个完整 ChapterFact 示例 | 引导 LLM 理解预期粒度 |
| 轻量后验证 | 名称长度 2-10 字符、类型合法、引用人物在上下文中存在 | 替代 V1 的 300+ 规则 |
| 跨章一致性 | 别名合并（编辑距离）、实体消歧（上下文相似度） | 在聚合层处理 |
| 辅助规则 | 地点层级正则增强（复用 V1 空间规则精华） | 仅作为补充，非主要手段 |

### 2.7 架构优势

1. **PRD 需求完整覆盖** — ChapterFact 模型直接映射到 PRD 的 4 种实体卡片所需的全部数据
2. **天然增量更新** — 重新分析某章只需重新抽取该章的 ChapterFact，聚合层自动重建
3. **天然错误恢复** — 某章抽取失败不影响其他章节，可独立重试
4. **天然支持暂停/恢复** — 按章逐个处理，任何章节边界都是安全的暂停点
5. **LLM 调用效率** — 每章 1 次调用（V1 需要 2 次），且上下文利用更充分
6. **数据可溯源** — 所有数据锚定到具体章节，PRD 要求的"来源章节"开箱即用

---

## 3. 技术栈决策

_（待后续步骤补充：前端框架、后端框架、存储方案、可视化引擎等）_

---

## 4. 系统分层架构

_（待后续步骤补充：前端层、API 层、服务层、抽取层、存储层的划分）_

---

## 5. 数据模型设计

_（待后续步骤补充：数据库 Schema、ChapterFact 存储、聚合视图等）_

---

## 6. 关键模块设计

_（待后续步骤补充：分析任务队列、可视化数据接口、实体卡片聚合等）_
