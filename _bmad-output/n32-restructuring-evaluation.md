# N32 地点层级管道深度重构 — 架构评估报告

> **评估人**: Winston (System Architect)
> **日期**: 2026-02-26
> **评估对象**: 地点层级管道深度重构报告（4 阶段方案）
> **评估依据**: 当前代码库实际架构、DB 数据（4 部小说 / 241 章 chapter_facts）、红楼梦实测数据

---

## 一、总体评价

报告的核心诊断 **"GIGO — 源头提取质量是瓶颈"** 是准确的。当前 12 步巩固管道已经达到了"后处理极限"——每新增一条规则都会引入更多边界情况和副作用（如保守倒置检测 + 覆盖保护 + 振荡阻尼的交互复杂度已经很高）。

但报告提出的 4 个阶段**并非同等可行、同等必要**。以下逐一分析。

---

## 二、阶段逐项评估

### 阶段 1: 重构 ChapterFact 提取（container + peers）

#### 1.1 废弃 parent 改为 container + peers

| 维度 | 评估 |
|------|------|
| **技术可行性** | ⚠️ 中等风险 |
| **预期收益** | 🟢 高 — 直接消除"宁→荣"类噪声 |
| **实现难度** | 🔴 高 — 涉及全链路改动 |
| **向后兼容** | 🔴 破坏性 — 241 条已有 chapter_facts 全部无 container/peers 字段 |

**深度分析**:

**优点**: 思路正确。区分"物理包含"与"并列关系"从信息论角度是收益最高的改动——它从源头消除了最大的噪声类型（同级误判为父子）。

**问题 1 — 向后兼容性代价极高**:
- `LocationFact` 模型改动影响 **12+ 个消费者**：`fact_validator.py`（验证+消歧）、`context_summary_builder.py`（上下文注入）、`world_structure_agent.py`（投票收集 × 2 个方法）、`entity_aggregator.py`（位置聚合）、`hierarchy_consolidator.py`（巩固）、`visualization_service.py`（地图）、`encyclopedia_service.py`（百科）、`analysis_service.py`（分析统计）等
- 已有 241 条 `chapter_facts` 的 JSON 中 `locations[].parent` 字段需要迁移或兼容处理
- 前端 `NovelMap.tsx`、`WorldStructureEditor.tsx` 等组件也依赖 parent 层级关系

**问题 2 — LLM 能否可靠区分 container vs peers**:
- 当前 LLM（qwen3:8b 本地模型）连 `parent` 都经常搞错，要求它可靠区分"物理包含"与"并列"是更高难度的认知任务
- 实际小说文本中，包含 vs 并列的边界模糊（大观园和荣国府之间，既有包含关系又在某些语境下并列提及）
- 需要实测验证：在 8B 本地模型上，container/peers 的准确率是否真的优于当前 parent

**问题 3 — peers 信号的消费路径不清晰**:
- 报告提到"peers 推断共同父级"，但如何将 peers 信号融入现有投票系统？需要新的投票源类型
- 如果 A 和 B 是 peers，它们的共同父级 C 从哪来？仍然需要 LLM 推断或常识查表

**替代方案** 🏗️:
> **不废弃 parent，而是新增 peers 作为可选字段**。保留 parent 的向后兼容性，同时在投票阶段利用 peers 信号：当 A→B 和 B→A 都有投票且存在 peers 关系时，自动触发兄弟聚类逻辑。这样改动范围缩小 80%，且可渐进式推出。

#### 1.2 上下文锚点注入（Contextual Anchoring）

| 维度 | 评估 |
|------|------|
| **技术可行性** | 🟢 高 — 已有基础设施 |
| **预期收益** | 🟢 高 — 解决"都中隐身"问题 |
| **实现难度** | 🟢 低 — 改动集中在 1 个文件 |
| **向后兼容** | 🟢 完全兼容 |

**深度分析**:

**这是报告中 ROI 最高的建议**。原因：

1. **基础设施已存在**: `ContextSummaryBuilder` 已经注入层级链（`_format_hierarchy_chains`）和焦点地点（`_format_scene_focus`）。只需在已有的注入逻辑中增加一个 "宏观枢纽" 段落
2. **改动极小**: 只需修改 `context_summary_builder.py` 的 `build()` 方法，从 `WorldStructure.location_parents` 中提取深度≤2 的节点作为 "已知宏观区域" 注入
3. **零向后兼容问题**: 不改 schema，不改消费者，只影响后续章节的 LLM prompt
4. **可立即验证**: 对红楼梦重新分析几章，观察 LLM 是否开始正确输出 `parent="都中"`

**唯一风险**: prompt 长度增加可能影响 8K context 的本地模型。但 `TokenBudget` 已有自适应机制，宏观枢纽列表通常很短（5-15 个节点），增加 ~200 token 完全可控。

---

### 阶段 2: 自上而下的世界观骨架（Macro-Skeleton）

| 维度 | 评估 |
|------|------|
| **技术可行性** | ⚠️ 中等 — 依赖 LLM 质量 |
| **预期收益** | 🟡 中等 — 锁定顶层但不解决叶子节点 |
| **实现难度** | ⚠️ 中等 — 新流程节点 + 权重融合 |
| **向后兼容** | 🟢 兼容 — 只影响重建流程 |

**深度分析**:

**优点**: 思路合理。预先确定 `天下→[都中, 金陵, 姑苏]→[荣国府, 宁国府, ...]` 的骨架，确实能锁定顶级结构不被微观噪声破坏。

**问题 1 — "100 票权重"过于刚性**:
- 报告建议赋予 100 票权重。但如果 LLM 骨架本身有错误（比如把大观园放在了宁国府下面），100 票会让这个错误无法被后续章节证据修正
- **建议**: 使用 10-15 票的"强基线"而非"绝对锁定"，允许压倒性的逐章证据翻转

**问题 2 — 输入材料不确定**:
- "小说简介"：很多小说没有结构化简介
- "目录"：章节标题通常不含地理信息（红楼梦："甄士隐梦幻识通灵"）
- "前 10 章剧情摘要"：已有 `context_summary_builder` 的摘要，但要求 LLM 从中生成骨架树是新的 prompt 设计任务
- 实际可用的最好材料是**前 N 章已提取的 chapter_facts 汇总**——但这和 rebuild 中的投票重建本质相同

**问题 3 — 适用范围有限**:
- 对红楼梦（场景集中、地理明确）效果好
- 对网文（世界观渐进展开、前 10 章可能还在新手村）效果差
- 对翻译文学（地理分散、无明确层级）意义不大

**替代方案** 🏗️:
> **不新增独立步骤，而是增强现有的 `_rebuild_parent_votes` 基线注入**。在 rebuild 流程的 Step 1（重新检测类型）之后，用一次轻量 LLM 调用确认/修正 `saved_parents` 中的顶层 2-3 个关键关系（如 "荣国府的父级是都中还是天下？"），然后将确认的关系以 weight=10 注入基线。这比从零生成骨架更可靠。

---

### 阶段 3: 算法定向手术

#### 3.1 后缀 Rank 歧义修复（Tier 一致性校验）

| 维度 | 评估 |
|------|------|
| **技术可行性** | 🟢 高 |
| **预期收益** | 🟡 中等 — 解决"府"歧义但覆盖面窄 |
| **实现难度** | 🟢 低 — ~20 行代码 |
| **向后兼容** | 🟢 完全兼容 |

**深度分析**:

建议的逻辑是：当 tier=building 时，"府" 降级为 rank 5+。这在当前代码中实现很简单（在 `_get_suffix_rank()` 调用后加一个 tier 校验层）。

**但有一个矛盾**: 报告的前提是"LLM 分类 tier 不可靠"（GIGO），却在这里又依赖 tier 来校正 suffix rank。如果 tier 本身是错的（荣国府被 LLM 分类为 building），那这个校验反而会加剧问题。

**务实建议**: 只在 tier 与 suffix **严重矛盾**时生效（差距 ≥ 3 个 rank level），且仅降级不升级。这样可以捕获明确的错误（如 tier=building + suffix=国），同时避免在模糊区间引入新错误。

**当前系统已有的防护**: Step 2b 的"保守倒置检测"已经通过"混合情况跳过"规避了大部分 suffix/tier 矛盾。此修复是增量改善而非根本性修复。

#### 3.2 微小地点修剪（Micro-location Pruning）

| 维度 | 评估 |
|------|------|
| **技术可行性** | 🟢 高 |
| **预期收益** | 🟢 高 — 减少噪声节点 30-50% |
| **实现难度** | 🟢 低 — ~40 行代码 |
| **向后兼容** | 🟡 轻微影响 — 地图上少显示一些点 |

**深度分析**:

这是**性价比极高的改动**。红楼梦中"门槛""临窗大炕""粪窖边"等微小地点确实不应参与全局层级计算。

**建议实现路径**:
- 在 `_resolve_parents()` 或 `consolidate_hierarchy()` 入口处，先过滤掉 `total_votes ≤ 2` 且名称匹配微小结构词的地点
- 过滤后的地点不参与投票、不参与巩固、不生成 parent 关系
- 但保留在 `location_tiers` 中（用于百科显示），只是标记为 `micro=True`
- 地图渲染层根据 `micro` 标记决定是否显示

**需要注意**: "门"字同时出现在微小结构（门槛、门口）和正式地名（玄武门、午门）中。过滤规则需要结合长度和上下文，不能简单匹配单个字。

#### 3.3 兄弟聚类（Sibling Clustering）

| 维度 | 评估 |
|------|------|
| **技术可行性** | ⚠️ 中等 |
| **预期收益** | 🟡 中等 — 解决"宁荣互指"但场景有限 |
| **实现难度** | ⚠️ 中等 — 需要新的投票分析逻辑 |
| **向后兼容** | 🟢 完全兼容 |

**深度分析**:

逻辑上正确：A→B 和 B→A 票数接近 + 同后缀 → 兄弟关系 → 找共同第三者。

**问题**: "共同出现的最高频第三者" 这个信号在当前投票数据中不直接可用。需要额外的共现分析（哪些章节同时提到 A、B 和 C？）。这等于新增一个投票源。

**当前系统已有的部分处理**: `_resolve_parents()` 的"双向冲突解决"步骤已经检测 A→B 且 B→A 的情况，使用 suffix rank 打破。兄弟聚类是对此的增强——不只是打破方向，而是将双方都提升为同级。

**建议**: 可以在 `_resolve_parents()` 的双向冲突解决步骤中增加：当票数比 < 1.5:1 且后缀相同时，两个方向都删除，然后触发"共同父级搜索"（从 chapter_facts 中找与 A、B 共现最多的更高层级地点）。

---

### 阶段 4: LLM 验证优化

#### 4.1 子图分治验证

| 维度 | 评估 |
|------|------|
| **技术可行性** | 🟢 高 |
| **预期收益** | 🟢 高 — 解决超时 + 提升精度 |
| **实现难度** | 🟢 低-中 — 拆分逻辑 + 并发调用 |
| **向后兼容** | 🟢 完全兼容 |

**深度分析**:

当前 `validate_hierarchy()` 将所有直接子节点（最多 50 个）一次性发给 LLM，对于红楼梦这种复杂小说，LLM 需要在 60s 内理解整棵树并输出修正——认知负荷确实过高。

**子图切片是正确的方向**。实现建议：
- 按 uber_root 的直接子节点切片：每个大子树（都中子树、金陵子树）独立验证
- 使用 `asyncio.gather()` 并发执行
- 单个子图控制在 20-30 个节点
- 合并结果时检查跨子图冲突（极少见）

**已有代码基础**: `review()` 方法已实现分批处理（`_BATCH_SIZE=70`），只需将"按数量分批"改为"按子树分批"。

#### 4.2 自我反思机制

| 维度 | 评估 |
|------|------|
| **技术可行性** | 🟡 取决于模型 |
| **预期收益** | 🟡 中等 — 对特定顽固错误有效 |
| **实现难度** | 🟢 低 — prompt 调整 |
| **向后兼容** | 🟢 完全兼容 |

**深度分析**:

"自我反思"本质上是在 validation prompt 中增加显式的逻辑检查步骤。对于云端大模型（GPT-4、Claude）效果好，但对于 8B 本地模型，增加推理步骤可能导致更多 token 消耗和超时。

**建议**: 将反思机制设计为可选的"第二轮验证"——只对第一轮验证标记为 medium confidence 的修正进行反思确认，控制调用次数。

---

## 三、ROI 排序与建议执行路径

按**投入产出比**从高到低排序：

| 优先级 | 改动 | 投入 | 预期收益 | 风险 |
|--------|------|------|----------|------|
| **P0** | 1.2 上下文锚点注入 | 0.5 天 | 🟢🟢🟢 解决"都中隐身" | 极低 |
| **P0** | 3.2 微小地点修剪 | 0.5 天 | 🟢🟢🟢 减少 30-50% 噪声节点 | 低 |
| **P1** | 4.1 子图分治验证 | 1 天 | 🟢🟢 解决超时 + 提升精度 | 低 |
| **P1** | 3.3 兄弟聚类（简化版） | 1 天 | 🟢🟢 解决"宁荣互指" | 中 |
| **P2** | 3.1 后缀 Rank 歧义 | 0.5 天 | 🟡 增量改善 | 中 |
| **P2** | 2.1 宏观骨架（轻量版） | 1.5 天 | 🟡🟢 锁定顶层结构 | 中 |
| **P3** | 1.1 container+peers | 3-5 天 | 🟢🟢🟢 根本性改善 | 🔴 高 |
| **P3** | 4.2 自我反思 | 0.5 天 | 🟡 对特定场景有效 | 低 |

---

## 四、建议执行路径

### Sprint 1 — 快速见效（1-2 天）

**目标**: 用最小改动获得最大改善

1. **上下文锚点注入** (P0): 修改 `context_summary_builder.py`，在 prompt 中注入 "已知宏观区域" 列表
2. **微小地点修剪** (P0): 在 `_resolve_parents()` 入口处过滤低票微小地点

**验证**: 重新分析红楼梦 5-10 章，观察 parent 提取质量变化

### Sprint 2 — 验证层强化（1-2 天）

3. **子图分治验证** (P1): 重构 `validate_hierarchy()` 为按子树并发验证
4. **兄弟聚类** (P1): 在 `_resolve_parents()` 双向冲突解决中增加兄弟检测

**验证**: 红楼梦完整重建，天下直接子节点 ≤ 20

### Sprint 3 — 结构性提升（评估后决定）

5. 根据 Sprint 1-2 的效果评估是否需要阶段 2（宏观骨架）
6. **container+peers 方案需要独立 spike**：先在红楼梦上 A/B 测试 prompt 修改（不改 schema，只在 prompt 中要求区分 container/peers，但仍输出到 parent 字段），验证 LLM 是否能可靠区分

---

## 五、架构级风险与注意事项

### 1. 双模型适配
所有改动必须同时适配 **本地 8B 模型** 和 **云端大模型**。上下文锚点注入需要有 token 预算保护；子图分治验证在本地模型上可能需要更宽松的超时。

### 2. 数据迁移
container+peers 方案（如果最终采用）需要设计迁移策略：
- 方案 A：保留 `parent` 字段向后兼容，新增 `container`/`peers` 为可选字段
- 方案 B：迁移脚本将现有 `parent` 映射为 `container`（假设 parent 都是包含关系）
- **强烈推荐方案 A**——渐进式演进，不破坏已有数据

### 3. 重分析 vs 重建
当前有两条路径：`AnalysisService`（逐章分析）和 `rebuild_hierarchy`（重建层级）。阶段 1 的改动只影响前者（新分析产生更好的数据），阶段 2-4 主要影响后者。需要明确每个改动的作用范围。

### 4. 效果衡量
建议引入量化指标：
- **天下直接子节点数**（目标 ≤ 20）
- **已知错误关系数**（宁→荣等标记的错误）
- **重建稳定性**（连续两次重建的 diff 变化量）
- 每次迭代后记录这些指标，用数据驱动决策

---

## 六、总结

报告的方向判断是正确的——"从重度后处理转向提升源头质量"。但实施路径需要更务实：

1. **不要一步到位**: container+peers 的全链路重构风险过高，应先用轻量方式（锚点注入 + 微小地点修剪 + 兄弟聚类）验证"改善源头"的效果
2. **不要丢弃后处理**: 12 步巩固管道仍然有价值——它处理的是 LLM 永远无法 100% 正确的长尾情况。正确策略是"减轻后处理负担"而非"替代后处理"
3. **用数据说话**: 每个改动都应该有明确的 A/B 测试——改动前后对同一部小说的层级质量对比

**一句话**: 先做 P0（锚点注入 + 微小修剪），观察效果，再决定是否需要更深的重构。
