---
workflowType: prd
workflow: edit
classification:
  domain: consumer-productivity
  projectType: desktop_app
  complexity: low
inputDocuments:
  - _bmad-output/target-user-research-series-bible.md
  - _bmad-output/product-feature-alignment-analysis.md
  - _bmad-output/delivery-mode-analysis.md
  - _bmad-output/monetization-execution-plan.md
  - _bmad-output/user-guidance-system-design.md
stepsCompleted:
  - step-e-01-discovery
  - step-e-02-review
  - step-e-03-edit
lastEdited: '2026-02-17'
---

# AI Reader V2 产品需求文档 (PRD) v1.3

> 版本：1.3
> 日期：2026-02-17
> 状态：结构性改进
> 基于：用户研究报告 + 功能对齐分析 + 交付模式战略 + BMAD验证报告

---

## 目录

1. [产品概述](#1-产品概述)
2. [成功标准](#2-成功标准)
3. [目标用户](#3-目标用户)
4. [核心用户旅程](#4-核心用户旅程)（J1~J5）
5. [核心功能](#5-核心功能)
   - 5.2 样本小说体验
   - 5.3 功能需求列表（FR-001~FR-015）
   - 5.4 功能详细设计（实体卡片/导出/剧本/冲突检测/时间线/势力图）
   - 5.5 产品范围（MVP/Growth/Vision）
6. [产品架构](#6-产品架构)
   - 平台支持规划
   - LLM配置与成本管理
   - 分析成本控制系统
7. [用户界面](#7-用户界面)
8. [帮助体系](#8-帮助体系)
9. [非功能需求](#9-非功能需求)
10. [用户行为分析](#10-用户行为分析)
11. [商业化策略](#11-商业化策略)
12. [实施路线图](#12-实施路线图)
13. [附录](#13-附录)

---

## 1. 产品概述

### 1.1 产品定位

AI Reader V2 是一个**本地优先的智能小说分析与管理平台**，专为中文小说创作者和改编者设计。它将小说文本转化为结构化知识图谱，提供实体管理、可视化分析、设定一致性检查，以及 Series Bible 导出功能。

**核心价值主张**：
> "你的小说数据完全属于你自己。AI 分析在本地完成，团队协作按需上云。"

### 1.2 解决的问题

| 痛点 | 描述 | 解决方案 |
|------|------|---------|
| 设定一致性 | 300万字长篇中角色、武力体系、地理设定容易"吃书" | 自动知识图谱 + 冲突检测 |
| 信息检索困难 | 写到第800章忘了第200章的设定细节 | 实体卡片 + 智能问答 |
| 改编效率低 | IP改编需1个月读原作+1个月梳理设定 | AI自动提取 + 一键导出 |
| 隐私担忧 | 网文作者担心作品被平台用于AI训练 | 本地优先 + 数据不出设备 |
| 团队协作难 | 工作室多开、编剧室协作缺乏工具 | 导出共享（文件形式，后续考虑云端） |

### 1.3 产品愿景

成为中文小说创作生态的**基础设施**——从创作辅助到 IP 改编，为每一个故事提供结构化的知识管理。

---

## 2. 成功标准

### 2.1 核心业务指标（SMART）

| 指标 | 定义 | Phase 1 目标 | Phase 2 目标 | 测量方式 |
|------|------|-------------|-------------|---------|
| 下载量 | 累计安装用户数 | > 10,000 | > 30,000 | 下载统计 |
| 激活率 | 下载 → 完成首次分析 | > 60% | > 65% | 本地埋点 |
| 7日留存 | 安装后7天内再次使用 | > 50% | > 55% | 本地埋点 |
| NPS | 净推荐值（用户调研） | > 40 | > 50 | 应用内问卷 |
| 付费转化率 | 免费用户 → Pro | - | > 10% | 授权系统 |
| MRR | 月经常性收入 | - | > ¥10,000 | 支付系统 |

### 2.2 产品体验指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 样本小说首次体验完成率 | > 80% | 首次启动 → 浏览完样本小说3个以上功能页面 |
| 分析完成率 | > 70% | 开始分析 → 成功完成全部章节 |
| 导出功能渗透率 | > 40% | 至少使用过1次导出的活跃用户占比 |
| 问答满意度 | > 3.5/5 | 用户对AI问答结果的评分 |
| 首次分析等待容忍度 | < 3分钟/章（本地） | 单章分析耗时上限 |
| 隐私信任度 | > 80% | 用户调研中"认为数据安全"的比例（应用内问卷） |

### 2.3 决策检查点

| 检查点 | 时机 | 关键指标 | Go/No-Go 决策 |
|--------|------|---------|---------------|
| CP1 | MVP发布后3个月 | NPS > 40，自然增长 > 20%/月 | 继续Pro版 or 重新评估 |
| CP2 | Pro版发布后3个月 | 转化率 > 8%，退款率 < 5% | 继续团队版 or 调整定价 |
| CP3 | 团队版发布后6个月 | 客户 > 10，续约率 > 80% | 规模化 or 转向纯企业服务 |

---

## 3. 目标用户

### 3.1 用户画像

#### 群体一：网文作者（核心用户）

**细分类型**：
- 个人作者（1-3部连载，日更3000-6000字）- 数百万规模
- 工作室作者（日更1万字以上，多开操作）- 数十万规模
- 头部签约作者（有IP改编潜力）- 数千规模

**核心需求**：
- 长文设定一致性检查
- 多开作品管理
- 快速生成设定卡给枪手
- 数据隐私保护（防"AI投喂"）

**导出格式偏好**：Markdown > Excel > JSON

#### 群体二：传统出版作者

**特征**：出版社签约，作品周期1-3年，系列作品跨度5-10年

**核心需求**：
- 跨书设定管理
- 编辑协作（Word/PDF导出）
- 角色一致性追踪

**导出格式偏好**：Word > PDF > Markdown

#### 群体三：编剧/脚本作者

**特征**：影视、动画、剧本杀领域，高度协作性

**核心需求**：
- 小说→剧本结构转换
- 场景提取与展示
- 角色小传生成
- 分场大纲导出

**导出格式偏好**：剧本格式 > PDF > XMind

#### 群体四：IP改编编辑（高价值用户）

**特征**：游戏公司文案策划、漫画编辑、影视IP开发

**核心需求**：
- 快速理解原作世界观
- 角色/NPC数据表（Excel）
- 势力关系矩阵
- 跨团队协作（通过导出文件实现）

**导出格式偏好**：Excel > Word > JSON > PPT
**付费意愿**：极高（企业采购，通过团队授权方式）

### 3.2 用户需求矩阵

| 需求 | 网文作者 | 传统作者 | 编剧 | IP改编 |
|------|---------|---------|------|--------|
| 本地隐私 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ |
| 设定一致性 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ |
| 剧本模式 | ⭐ | ⭐ | ⭐⭐⭐ | ⭐⭐ |
| Excel导出 | ⭐⭐ | ⭐⭐ | ⭐ | ⭐⭐⭐ |
| 导出共享 | ⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |

---

## 4. 核心用户旅程

### 4.1 旅程一：首次启动 → 样本体验（零门槛上手）

**用户**：所有新用户
**目标**：安装后 5 分钟内体验到产品核心价值

```
安装完成 → 首次启动
    │
    ▼
┌─────────────────────────────────────────────────┐
│  环境配置向导                                     │
│  ┌───────────────────────────────────────────┐  │
│  │ 检测到 Ollama 已安装 ✅                    │  │
│  │ 可用模型：qwen3:8b ✅                      │  │
│  │                                            │  │
│  │ 或者：                                     │  │
│  │ 未检测到 Ollama                            │  │
│  │ [一键安装 Ollama] [跳过，使用云端API]       │  │
│  │ [先体验样本小说（无需LLM）]                │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│  选择体验方式                                     │
│                                                   │
│  ┌─────────────┐  ┌──────────────────────────┐  │
│  │  🏔️ 西游记  │  │  📖 上传我自己的小说     │  │
│  │  前25回      │  │                          │  │
│  │  已预分析    │  │  支持 .txt / .md 格式    │  │
│  │              │  │                          │  │
│  │ [立即体验]   │  │  [选择文件]              │  │
│  └─────────────┘  └──────────────────────────┘  │
│                                                   │
│  💡 样本小说已包含完整分析数据，无需等待           │
└─────────────────────────────────────────────────┘
    │
    ▼ 选择"立即体验"
┌─────────────────────────────────────────────────┐
│  引导式功能展示（步骤气泡）                       │
│                                                   │
│  步骤1/4：阅读页                                  │
│  → 实体高亮已开启，点击"孙悟空"查看人物卡片       │
│                                                   │
│  步骤2/4：关系图                                  │
│  → 查看取经团队的人物关系网络                     │
│                                                   │
│  步骤3/4：世界地图                                │
│  → 花果山、天宫、长安...真实地理坐标展示          │
│                                                   │
│  步骤4/4：导出                                    │
│  → 一键导出完整 Series Bible 设定文档             │
│                                                   │
│  ✅ 体验完成！                                    │
│  [上传我自己的小说] [继续探索西游记]              │
└─────────────────────────────────────────────────┘
```

**成功标准**：首次体验完成率 > 80%
**追溯**：FR-001, FR-013

### 4.2 旅程二：上传 → 分析 → 探索

**用户**：所有用户
**目标**：上传小说后顺利完成分析并发现有价值的信息

```
书架页 [上传小说]
    │
    ▼
┌─────────────────────────────────────────────────┐
│  上传与切分                                       │
│  → 选择TXT文件 → 自动检测章节标记 → 预览章节列表 │
│  → 确认切分结果 → 进入分析页                     │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│  分析配置                                         │
│  → 选择分析范围（全书/部分章节）                  │
│  → 可选：实体预扫描（提升提取质量）               │
│  → 云端模式显示：预估成本 ¥X.XX                  │
│  → [开始分析]                                    │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│  分析进度（WebSocket实时推送）                     │
│  → 进度条 + 当前处理章节 + 已发现实体数           │
│  → 支持暂停/恢复/取消                            │
│  → 分析完成 → 自动跳转到阅读页                   │
└─────────────────────────────────────────────────┘
    │
    ▼
  阅读页（实体高亮）→ 关系图 → 地图 → 百科 → 问答
```

**追溯**：FR-001, FR-002, FR-003, FR-004, FR-005, FR-006

### 4.3 旅程三：分析完成 → 导出 Series Bible

**用户**：付费用户（Pro/团队版）
**目标**：将分析结果转化为可交付的设定文档

```
任意功能页面 → 导航栏 [导出]
    │
    ▼
  选择格式 → 选择内容模块 → 选择模板 → 预览 → 导出下载
```

**追溯**：FR-009

### 4.4 旅程四：智能问答探索

**用户**：所有用户（分析完成后）
**目标**：通过自然语言问答快速获取小说细节，验证AI理解质量

```
阅读页/任意功能页 → ⌘K 或点击问答入口
    │
    ▼
┌─────────────────────────────────────────────────┐
│  智能问答                                         │
│                                                   │
│  💬 输入你的问题…                                │
│  例："孙悟空第一次和猪八戒见面是在哪一回？"       │
│                                                   │
│  ┌─────────────────────────────────────────────┐ │
│  │  🤖 在第十八回，孙悟空在高老庄与猪八戒      │ │
│  │  初次相遇。猪八戒化名"猪刚鬣"入赘高家…     │ │
│  │                                              │ │
│  │  📖 来源：第18章 第3段                       │ │
│  │  [跳转到原文]                                │ │
│  └─────────────────────────────────────────────┘ │
│                                                   │
│  用户可继续追问 → 多轮对话                        │
│  每次回答附带来源章节 → 点击可跳转到原文          │
│                                                   │
│  📊 回答满意吗？ [👍] [👎]                       │
│                                                   │
└─────────────────────────────────────────────────┘
```

**成功标准**：问答满意度 > 3.5/5
**追溯**：FR-012

### 4.5 旅程五：设定审查与冲突检测

**用户**：网文作者（长篇连载）、传统出版编辑
**目标**：发现和解决作品中的设定矛盾，保障内容一致性

```
分析完成 → 导航栏 [设定审查] 或 百科页 [冲突检测]
    │
    ▼
┌─────────────────────────────────────────────────┐
│  设定冲突检测报告                                  │
│                                                   │
│  ⚠️ 发现 3 处潜在冲突                            │
│                                                   │
│  ┌─ 严重 ──────────────────────────────────────┐ │
│  │ 角色年龄矛盾                                 │ │
│  │ 第10章：林小月18岁  vs  第50章：20岁（仅隔1年）│ │
│  │ [查看原文对比]  [标记为已知]  [忽略]          │ │
│  └──────────────────────────────────────────────┘ │
│                                                   │
│  ┌─ 一般 ──────────────────────────────────────┐ │
│  │ 地点层级矛盾                                 │ │
│  │ 第22章："青牛镇在云州"  vs  第35章："青牛镇在 │ │
│  │ 雷州"                                        │ │
│  │ [查看原文对比]  [标记为已知]  [忽略]          │ │
│  └──────────────────────────────────────────────┘ │
│                                                   │
│  筛选：[全部] [严重] [一般] [已处理]             │
│                                                   │
└─────────────────────────────────────────────────┘
```

**成功标准**：严重冲突召回率 > 80%（通过人工标注验证）
**追溯**：FR-011

---

## 5. 核心功能

### 5.1 功能架构

```
AI Reader V2
├── 📚 书架管理
│   ├── 小说上传（.txt/.md）
│   ├── 章节自动切分
│   └── 元信息编辑
│
├── 📖 阅读与分析
│   ├── 章节阅读
│   ├── 实体高亮（人物/地点/物品/组织/概念）
│   ├── 实体卡片系统
│   └── AI分析引擎
│
├── 🕸️ 可视化分析
│   ├── 人物关系图
│   ├── 世界地图
│   ├── 时间线
│   └── 势力图
│
├── 📤 Series Bible导出中心
│   ├── Markdown导出
│   ├── Word导出
│   ├── Excel导出
│   └── PDF导出
│
├── 🎬 剧本模式（实验性，需深入研究）
│   ├── 章节级场景组织（一章多场景）
│   ├── 并列模式（原文+剧本并排）
│   ├── 独占模式（场景全屏展示）
│   └── 场景导航（章节内场景切换）
│
├── 💬 智能问答
│   ├── 自然语言问答
│   ├── 对话历史
│   └── 来源溯源
│
└── 📊 用户行为分析（产品迭代数据支撑）
    ├── 功能使用统计
    ├── 导出格式偏好分析
    └── 用户路径分析
```

### 5.2 样本小说体验（零门槛上手）

#### 5.2.1 设计理念

用户安装应用后，无需配置LLM、无需准备自己的小说、无需等待分析，即可立即体验全部功能。

#### 5.2.2 样本小说选择标准

| 标准 | 权重 | 说明 |
|------|------|------|
| **实体丰富度** | 最高 | 人物、地点、组织、物品、概念五类实体均需覆盖 |
| **用户熟悉度** | 高 | 用户已知原作内容，可直接验证提取质量 |
| **版权安全性** | 最高 | 必须为公版作品（著作权保护期已过） |
| **系统能力展示** | 高 | 能同时展示关系图、地理地图、势力图、时间线 |
| **文本处理友好** | 中 | 白话文或接近白话文，jieba分词效果好 |

#### 5.2.3 方案对比与决策

**公版经典名著 vs AI生成小说**：

| 维度 | 公版经典名著 | AI生成小说 |
|------|------------|-----------|
| 用户熟悉度 | ✅ 读者已知故事，可验证提取质量 | ❌ 全新故事，无法验证 |
| 版权风险 | ✅ 零风险（公版） | ✅ 零风险（自有） |
| 可信度 | ✅ "连西游记都能分析好" = 强信任信号 | ⚠️ 可能被质疑"只能处理简单文本" |
| 功能覆盖 | ✅ 经典名著天然包含复杂实体网络 | ⚠️ 需精心设计才能覆盖所有功能 |
| NLP友好度 | ⚠️ 半白话文，部分诗词段落 | ✅ 现代白话文，分词准确 |
| 情感连接 | ✅ 看到"孙悟空"的人物卡片会产生惊喜 | ❌ 无情感连接 |

**决策：采用公版经典名著为主，AI生成现代短篇为辅**

#### 5.2.4 内置样本小说

| 样本 | 来源 | 章节范围 | 字数 | 选择理由 |
|------|------|---------|------|---------|
| **《西游记》前25回** | 公版（明·吴承恩，1592年） | 第1-25回 | ~20万字 | 人物丰富（40+）、势力清晰（天庭/佛界/妖界）、GeoNames匹配（花果山/长安/五行山均有真实坐标） |
| **《三国演义》前30回** | 公版（元末明初·罗贯中） | 第1-30回 | ~18万字 | 关系图最佳展示（100+人物密集交织）、真实历史地理（洛阳/许昌/虎牢关完美匹配GeoMap）、三大势力清晰 |

**《西游记》前25回可展示的系统能力**：

| 功能 | 展示效果 |
|------|---------|
| **实体卡片** | 孙悟空（别称：美猴王/齐天大圣/行者，境界演变：石猴→仙→佛）、唐僧、猪八戒、沙僧等40+角色 |
| **关系图** | 师徒关系链、天庭层级（玉帝→太白金星→天兵）、敌对关系（取经团队 vs 各路妖怪） |
| **世界地图** | 花果山→东海→天宫→五行山→长安→鹰愁涧→高老庄→流沙河（GeoNames真实坐标） |
| **势力图** | 天庭、西方佛界、妖族、龙族四大阵营 |
| **时间线** | 从石猴出世→大闹天宫→被压五行山→唐僧取经出发→收三徒弟 |
| **概念百科** | 七十二变、筋斗云、紧箍咒、天庭官制、修炼体系 |
| **物品卡片** | 如意金箍棒、九齿钉耙、锦斓袈裟 |

**《三国演义》前30回额外展示**：

| 功能 | 展示效果 |
|------|---------|
| **GeoMap真实地图** | 洛阳、虎牢关、许昌、徐州、下邳等——全部匹配GeoNames CN数据集，Leaflet地图效果最佳 |
| **密集关系图** | 100+人物、多层关系（君臣/同盟/敌对/亲属），充分展示图谱可读性优化 |
| **势力演变** | 汉室→群雄割据→魏蜀吴初现，动态势力变化 |

#### 5.2.5 预计算数据与用户体验

**用户可感知的行为**：
- 应用内置两本样本小说的完整预分析数据（章节文本 + 实体词典 + 分析结果 + 世界结构）
- 首次启动时自动导入，样本小说立即出现在书架，标记为"📖 内置样本"
- 用户可随时从书架删除样本小说释放空间
- 预分析数据质量与用户自行分析的结果一致

**存储开销**：
- 两本样本总计 < 4MB（压缩后），对安装包体积影响可忽略

> **实现参考**：样本数据存储结构、首次启动加载流程等技术细节见 Architecture 文档 §6 或独立技术规格。

#### 5.2.6 教学引导与产品体验融合

**引导策略：不打断，融入操作流**

```
┌─────────────────────────────────────────────────────────────┐
│ 📖 西游记 · 第一回 灵根育孕源流出 心性修持大道生            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ 引导气泡 ─────────────────────────┐                    │
│  │ 💡 试试点击高亮的人物名称           │                    │
│  │    查看 AI 自动生成的角色卡片       │                    │
│  │              [知道了] [不再提示]     │                    │
│  └─────────────────────────────────────┘                    │
│                                                             │
│  海外有一国，名曰傲来国。国近大海，海中有一座仙山，         │
│  名曰【花果山】。山上有一仙石，石产一卵，见风化为一         │
│  石猴。那猴在山中行走跳跃，食草木，饮涧泉……               │
│                                                             │
│  "花果山"、"石猴" 等实体以颜色高亮显示                     │
│                                                             │
│  ──── 底部功能发现条 ────────────────────────────────────  │
│  📊 关系图  🗺️ 世界地图  📅 时间线  📤 导出               │
│  ↑ 点击可跳转到对应的可视化页面                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**引导触发规则**：
- 仅在样本小说中显示引导气泡
- 每个引导点只展示一次，点击"知道了"后永久关闭
- 用户点击"不再提示"后关闭所有引导
- 引导状态持久化存储在 `user_state` 表

### 5.3 功能需求列表（BMAD 格式）

> 以下为正式功能需求声明，采用 `[主体] 可以 [能力]` 格式。各 FR 的详细设计见 §5.3.1~§5.3.8 补充说明。

| 编号 | 功能需求 | 优先级 | 旅程追溯 |
|------|---------|--------|---------|
| FR-001 | 用户可以上传 .txt/.md 格式的中文小说文件，系统自动检测并切分为章节，用户可预览、编辑切分结果和元信息 | P0 | J1, J2 |
| FR-002 | 用户可以在阅读页查看章节内容，系统以颜色编码（人物蓝/地点绿/物品橙/组织紫/概念灰）高亮识别到的实体，用户点击实体可查看详细卡片 | P0 | J2 |
| FR-003 | 用户可以查看人物、地点、物品、组织四类实体的详细卡片，卡片内容包括基本信息、关系演变链、时间线、关联实体，且卡片内实体可点击跳转 | P0 | J2 |
| FR-004 | 用户可以对已上传小说执行 AI 分析（支持全书或指定章节范围），分析过程通过 WebSocket 实时推送进度，支持暂停/恢复/取消，已完成章节结果不丢失 | P0 | J2 |
| FR-005 | 用户可以查看人物关系图（力导向图），支持边权重过滤、节点数过滤、关系类型筛选，400 节点/1000 边规模下 3 秒内渲染完成 | P0 | J2 |
| FR-006 | 用户可以在世界地图上查看小说地点分布，系统自动匹配真实地理坐标（GeoNames），支持地点标记点击查看详情、角色轨迹显示、手动拖拽重定位 | P1 | J2 |
| FR-007 | 用户可以查看以章节为轴的事件时间线，展示主要事件节点（角色登场/退场、关键冲突、地点转移），支持按角色/事件类型筛选，支持缩放浏览不同粒度 | P1 | J2 |
| FR-008 | 用户可以查看小说中的势力/阵营分布图，展示组织层级结构、势力间关系（同盟/敌对/从属）、成员归属，支持按章节范围查看势力演变 | P2 | J2 |
| FR-009 | 用户可以将分析结果导出为 Series Bible 文档，支持 Markdown、Word、Excel、PDF 四种格式，可选择导出内容模块（人物/关系/地图/时间线）和场景化模板（网文作者/编剧/游戏策划套件） | P0(Markdown) P1(Word/Excel/PDF) | J3 |
| FR-010 | 用户可以在剧本模式下查看按场景组织的小说内容，支持并列模式（原文+剧本并排、同步滚动）和独占模式（全屏场景），场景元素包括标题、时间、地点、角色、描述、对话 | P2 | — (实验性，待 J-编剧验证) |
| FR-011 | 用户可以运行设定冲突检测，系统自动识别角色属性矛盾、地点层级矛盾、关系演变逻辑冲突和时间线冲突，以严重程度排序展示，提供原文对比视图 | P2 | J5 |
| FR-012 | 用户可以通过自然语言问答查询小说内容，系统返回答案并附带来源章节溯源，支持多轮对话，用户可对答案评分（👍/👎），免费版每本累计 50 次 | P0 | J4 |
| FR-013 | 用户可以在首次启动时体验内置样本小说（《西游记》前25回 + 《三国演义》前30回），样本含完整预分析数据，无需配置 LLM 即可浏览所有功能 | P0 | J1 |
| FR-014 | 云端 LLM 用户可以在分析前查看成本预估，分析中查看实时费用追踪，分析后查看按章节的成本明细，系统在预算达到 80%/100% 时发出告警 | P0(云端模式) | J2 |
| FR-015 | 系统在本地匿名记录功能使用频率、导出格式偏好、分析完成率等行为数据（用户可关闭），为产品迭代提供数据依据 | P2 | — |

### 5.4 功能详细设计

> 以下为各 FR 的补充设计说明。

#### 5.4.1 实体卡片系统（FR-003 补充）

**人物卡片**：
- 基本信息（姓名、别称、性别）
- 外貌特征（按章节演变）
- 人物关系（演变链：初见→朋友→恋人→仇人）
- 能力（境界/修为、技能/武功、身份/职业）
- 物品关系（获得→使用→消耗）
- 经历时间线

**地点卡片**：
- 空间层级（上级/下级/关联地点）
- 环境描写演变
- 到访人物（常驻/到访分类）
- 发生事件

**物品卡片**：
- 物品描述演变
- 持有流转链
- 使用记录

**组织卡片**：
- 组织层级
- 成员管理（入职→升职→离职）
- 组织间关系

#### 5.4.2 Series Bible 导出中心（FR-009 补充）

**导出格式**：

| 格式 | 适用用户 | 内容 |
|------|---------|------|
| Markdown | 网文作者 | 轻量人物卡、势力分布、时间线 |
| Word | 传统出版 | 完整设定集、正式排版、编辑协作 |
| Excel | IP改编 | 角色表、势力矩阵、物品/技能表 |
| PDF | 通用 | 专业排版（含目录/页码/页眉）、只读分享 |

**场景化导出模板**：

```yaml
网文作者套件:
  - 人物设定卡
  - 势力分布图
  - 时间线大纲
  - 多开管理表

编剧套件:
  - 场景列表
  - 角色小传（剧本格式）
  - 分场大纲
  - 一句话梗概

游戏策划套件:
  - NPC数据表
  - 势力关系矩阵
  - 物品/技能表
  - 世界观设定文档
```

#### 5.4.3 剧本模式（FR-010 补充，实验性 - 需深入研究）

> ⚠️ **注意**：剧本模式为实验性功能，需要与专业编剧深度合作，验证其实际价值后再决定是否正式纳入产品。

**待研究问题**：
1. 场景边界自动识别的准确率能否达到专业编剧要求（>90%）？
2. 小说文本到剧本格式的转换规则是否通用，还是因类型而异？
3. 编剧真正需要的是"自动转换"还是"辅助结构化"？
4. 并排对比视图是否提高改编效率？

**研究计划**：
- 阶段1：邀请5-10位专业编剧进行深度访谈
- 阶段2：提供原型工具，收集实际使用反馈
- 阶段3：根据反馈决定功能取舍或调整

**功能设计（初稿，可能调整）**：

**场景组织**：
- 按章节组织场景，一个章节包含1-N个场景
- 场景按时间顺序排列，保持叙事连贯性
- 场景边界自动识别（基于地点变化、时间跳跃、人物出场等）

**显示模式**：
1. **并列模式（默认）**：
   - 左侧：原文，支持滚动阅读
   - 右侧：剧本视图，显示该章节所有场景列表
   - 同步滚动：剧本场景与原文段落联动高亮

2. **独占模式**：
   - 全屏显示单个场景
   - 顶部场景标签导航，可快速切换
   - 适合沉浸式阅读和编辑

**场景元素**：
- 场景标题（自动提取或AI生成）
- 时间标记（相对时间或绝对时间）
- 地点信息
- 角色列表（本场景出场角色）
- 场景描述（环境/动作）
- 对话（角色名+对白+动作提示）

#### 5.4.4 设定冲突检测（FR-011 补充）

**检测类型**：
- 角色属性矛盾（第10章18岁 vs 第50章20岁但只过1年）
- 地点层级矛盾
- 关系演变逻辑检查
- 时间线冲突

**展示方式**：
- 冲突列表（按严重程度排序：严重/一般/提示）
- 原文对比视图（并排显示矛盾段落，高亮冲突文本）
- 修改建议（AI 生成的一致性修复建议，仅供参考）

**质量指标**：
- 严重冲突召回率 > 80%（通过人工标注验证集衡量）
- 误报率 < 30%（避免大量无意义告警）

#### 5.4.5 时间线（FR-007 补充）

**数据来源**：
- 从 ChapterFact 中的 `events` 字段提取事件节点
- 事件类型：角色登场/退场、关键冲突/战斗、地点转移、物品获取/交接、组织变动
- 时间标记：以章节序号为基准轴，辅以文本中的相对/绝对时间（"三天后"、"贞观十三年"等）

**可视化形式**：
- 横轴时间线（章节为刻度），纵轴按角色/事件类型分泳道
- 事件节点以圆点/图标表示，悬停显示事件摘要
- 关键事件（涉及 3+ 角色或标记为"重大"）以大节点高亮
- 连线：同一角色的连续事件以线段连接，展示角色动态

**交互方式**：
- 缩放：鼠标滚轮/捏合缩放，从全书概览到单章详情
- 筛选：按角色（多选）、事件类型（多选）过滤
- 点击事件节点：展开事件详情卡片（含原文摘要 + 涉及角色 + 章节链接）
- 章节范围选择：支持 `chapter_start` / `chapter_end` 参数

**性能指标**：
- 500 章/2000 事件节点规模下 < 3 秒完成渲染
- 滚动和缩放帧率 ≥ 30fps

#### 5.4.6 势力图（FR-008 补充）

**数据来源**：
- 从 ChapterFact 中的 `org_events` 字段和 WorldStructure 中的组织层级提取
- 势力/阵营：组织实体（天庭、西方佛界、妖族等）
- 成员归属：人物与组织的从属关系（角色→阵营映射）
- 势力间关系：同盟、敌对、从属、中立（从 ChapterFact 关系字段推断）

**可视化形式**：
- 树形/层级图展示组织内部结构（组织→子组织→成员）
- 势力间关系以连线表示（同盟=绿色实线、敌对=红色虚线、从属=灰色箭头）
- 节点大小按成员数量或出场频率缩放
- 颜色编码按阵营区分

**交互方式**：
- 点击势力节点：展开组织详情卡片（成员列表、组织描述、组织间关系）
- 章节范围滑块：查看特定章节范围内的势力格局（展示势力演变）
- 筛选：按势力类型（政治/军事/宗教/家族）过滤
- 展开/折叠：组织内部层级可展开或折叠

**性能指标**：
- 20 个组织/200 个成员规模下 < 2 秒完成渲染

### 5.5 产品范围（Product Scope）

#### MVP 范围（Phase 1，v1.0）

| FR 编号 | 功能 | 优先级 |
|---------|------|--------|
| FR-001 | 小说上传、章节切分 | P0 |
| FR-002 | 章节阅读、实体高亮 | P0 |
| FR-003 | 实体卡片系统（人物/地点/物品/组织） | P0 |
| FR-004 | AI 分析引擎（暂停/恢复/取消） | P0 |
| FR-005 | 人物关系图 | P0 |
| FR-009 | Markdown 导出 | P0 |
| FR-012 | 智能问答（免费版 50 次/本） | P0 |
| FR-013 | 样本小说内置体验 | P0 |
| FR-014 | 分析成本预估与追踪（云端模式） | P0 |

#### Growth 范围（Phase 2-3，v1.1~v1.3）

| FR 编号 | 功能 | 优先级 | 目标版本 |
|---------|------|--------|---------|
| FR-006 | 世界地图（GeoNames 真实坐标） | P1 | v1.1 |
| FR-007 | 时间线 | P1 | v1.1 |
| FR-009 | Word/Excel/PDF 导出 | P1 | v1.1 |
| FR-008 | 势力图 | P2 | v1.3 |
| FR-010 | 剧本模式（需先完成编剧研究） | P2 | v1.2 |
| FR-011 | 设定冲突检测 | P2 | v1.3 |
| FR-015 | 用户行为分析系统 | P2 | v1.2 |

#### Vision 范围（Phase 4+，待评估）

| 功能 | 当前状态 | 启动条件 | 对应路线图 |
|------|---------|---------|-----------|
| **跨设备加密同步** | 概念阶段 | 团队版用户达到 100+ | §12.2 Phase 2 |
| **导出模板市场** | 概念阶段 | 导出功能渗透率 > 40% | §12.3 Phase 3 |
| **云端协作空间** | 概念阶段 | 团队版续约率 > 80% | §12.4 Phase 4 |
| **实时同步** | 概念阶段 | 用户强烈反馈 | §12.4 Phase 4 |
| **AI辅助创作** | 概念阶段 | 与专业作者合作验证 | §12.4 Phase 4 |
| **移动端应用** | 概念阶段 | 桌面端 MAU > 100,000 | §12.4 Phase 4 |

> **注**：Vision 功能不在当前开发范围内。加密同步和模板市场已列入 §12 路线图但尚无正式 FR 定义，将在对应 Phase 启动前补充需求。

**当前协作方案（v1.0 替代 Vision 协作功能）**：
- 通过 Word/Excel 导出实现团队共享
- 配合飞书/钉钉/企业微信等现有协作工具
- 团队成员各自使用本地软件，通过文件传递协作

---

## 6. 产品架构

### 6.1 平台支持规划

#### 6.1.1 桌面打包方案

**技术选型：Tauri 2.x + Python Sidecar**

| 候选方案 | 壳体积 | 内存占用 | 原生体验 | 决策 |
|---------|--------|---------|---------|------|
| **Tauri 2.x** | 2-10 MB | ~30 MB | 使用系统WebView，原生窗口 | ✅ 选用 |
| Electron | 80-120 MB | ~200 MB | 捆绑Chromium，体积大 | ❌ 排除 |

**选择Tauri的理由**：
1. **壳体积小**：Tauri 2-10 MB vs Electron 100+ MB，用户下载体验更好
2. **Sidecar支持**：Tauri `externalBin` 原生支持捆绑Python后端（PyInstaller编译后的二进制）
3. **自动更新**：内置 `@tauri-apps/plugin-updater`，支持增量更新
4. **签名公证**：macOS notarization 和 Windows code signing 均有官方支持

**安装包组成与体积**：

| 组件 | 体积 | 说明 |
|------|------|------|
| Tauri壳（前端+窗口管理） | ~5 MB | React前端打包 + Tauri运行时 |
| Python Sidecar（后端） | ~200 MB | PyInstaller打包FastAPI + SQLite + ChromaDB + jieba + numpy |
| 样本小说数据 | ~4 MB | 2本公版小说的预分析数据 |
| GeoNames数据 | ~15 MB | CN.zip + cities15000.zip（首次使用时按需下载亦可） |
| **总计** | **~224 MB** | 压缩后安装包 ~120 MB |

**体积优化策略**：
- PyInstaller `--exclude-module` 排除未使用的大型库
- GeoNames数据包改为首次使用地图功能时按需下载
- 嵌入模型（bge-base-zh-v1.5）首次启动时自动下载，不打入安装包
- 目标：初始安装包 < 100 MB（不含嵌入模型和GeoNames）

#### 6.1.2 平台支持矩阵

| 平台 | 优先级 | 发布版本 | 最低系统要求 | 安装格式 |
|------|--------|---------|-------------|---------|
| **macOS** (Apple Silicon) | P0 | v1.0 | macOS 12+, 8GB RAM, 2GB磁盘 | .dmg |
| **macOS** (Intel) | P0 | v1.0 | macOS 12+, 8GB RAM, 2GB磁盘 | .dmg |
| **Windows** (x64) | P0 | v1.0 | Windows 10 1803+, 8GB RAM, 2GB磁盘, WebView2 | .msi / .exe |
| **Windows** (ARM64) | P1 | v1.1 | Windows 11 ARM, 8GB RAM | .msi |
| **Linux** (x64) | P1 | v1.2 | Ubuntu 20.04+ / Fedora 36+, 8GB RAM | .AppImage / .deb |

**硬件推荐配置（按使用场景）**：

| 场景 | 内存 | 磁盘 | GPU | 说明 |
|------|------|------|-----|------|
| 仅查看样本/已分析数据 | 4 GB | 1 GB | 不需要 | 纯前端浏览 |
| 云端LLM分析 | 8 GB | 2 GB | 不需要 | LLM在远端运行 |
| 本地Ollama 7B模型 | 16 GB | 10 GB | MPS/CUDA可选 | 推荐Apple Silicon |
| 本地Ollama 14B模型 | 32 GB | 15 GB | MPS/CUDA推荐 | 最佳分析质量 |

#### 6.1.3 签名与公证

| 平台 | 要求 | 成本 | 不签名的后果 |
|------|------|------|-------------|
| **macOS** | Apple Developer Program + notarytool | $99/年 | Gatekeeper阻止运行，用户需手动允许 |
| **Windows** | EV Code Signing Certificate | ~$300/年 | SmartScreen"未知发布者"警告 |
| **Linux** | GPG签名（可选） | 免费 | 无影响 |

**注意**：Tauri打包含Python sidecar时，sidecar二进制需单独ad-hoc签名后再由Tauri整体公证（参考 [tauri#11992](https://github.com/tauri-apps/tauri/issues/11992)）。

#### 6.1.4 自动更新机制

```
更新检测流程：
1. 应用启动时请求 https://update.ai-reader.app/check
   → 返回 { version, url, signature, notes }
2. 比较版本号，若有新版本 → 显示更新提示
3. 用户选择：
   ├── [立即更新] → 下载 → 验证签名 → 安装 → 重启
   ├── [稍后提醒] → 24小时后再次提示
   └── [跳过此版本] → 不再提示该版本

技术实现：Tauri Updater Plugin
- 支持增量更新（差分包）
- 更新包签名验证（防篡改）
- 后台静默下载，不影响使用
```

#### 6.1.5 发布与CI/CD流程

```
代码提交
    │
    ▼
GitHub Actions CI
├── 前端：npm build + TypeScript check + ESLint
├── 后端：pytest（未来）+ pyright type check
└── 通过 → 触发构建
    │
    ▼
Tauri Build Matrix（并行）
├── macOS ARM64 (.dmg) — macOS runner
├── macOS x64 (.dmg) — macOS runner
├── Windows x64 (.msi) — Windows runner
└── Linux x64 (.AppImage) — Ubuntu runner
    │
    ▼
签名 & 公证
├── macOS: codesign + notarytool
├── Windows: signtool (EV cert)
└── Linux: GPG sign
    │
    ▼
发布渠道
├── GitHub Releases（主渠道）
├── 官网下载页（CDN加速）
└── 更新服务器（JSON manifest for Tauri Updater）
```

### 6.2 交付模式

**采用「本地优先」模式，云端服务仅在后续阶段按需探索**：

```
┌─────────────────────────────────────────┐
│         AI Reader V2 架构               │
├─────────────────────────────────────────┤
│                                         │
│   本地核心（桌面应用）- 免费/Pro          │
│   ├── 本地LLM分析（Ollama）              │
│   ├── 本地数据存储（SQLite/ChromaDB）    │
│   └── 完整功能（分析/阅读/导出）         │
│                                         │
│   未来探索（根据用户需求评估）            │
│   ├── 加密同步（跨设备）                 │
│   └── 团队协作空间（待定）               │
│                                         │
│   默认：100%本地运行，数据不出设备        │
│   协作：通过导出文件实现共享              │
│                                         │
└─────────────────────────────────────────┘
```

### 6.3 技术架构

**前端**：
- React 19 + TypeScript 5.9
- Tailwind CSS 4 + shadcn/ui
- Vite 7
- React Router 7

**后端（本地）**：
- Python 3.9+ + FastAPI
- SQLite (aiosqlite)
- ChromaDB + BAAI/bge-base-zh-v1.5
- Ollama（本地LLM）

**数据模型**：
- ChapterFact（核心数据模型）
- Entity Profiles（聚合实体卡片）
- World Structure（地点层级）

---

### 6.4 LLM配置与成本管理

#### 6.4.1 双模式LLM支持

| 模式 | 适用场景 | 配置方式 | 成本 |
|------|---------|---------|------|
| **本地LLM（推荐）** | 日常分析，隐私敏感 | Ollama自动检测/引导安装 | **免费**（仅消耗本地算力） |
| **云端LLM** | 追求速度，本地硬件不足 | 输入API Key | 按Token计费 |

#### 6.4.2 首次启动零配置体验

**设计目标：3步内完成LLM配置，或0步直接体验样本小说**

```
┌─────────────────────────────────────────────────────────────┐
│  🚀 欢迎使用 AI Reader V2                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  正在检测运行环境...                                         │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Ollama 状态                                        │   │
│  │                                                     │   │
│  │  情况A（已安装已运行）：                             │   │
│  │  ✅ Ollama 已运行                                   │   │
│  │  ✅ 可用模型：qwen3:8b (4.9GB)                      │   │
│  │  → 一切就绪，可以开始分析！                          │   │
│  │                                                     │   │
│  │  情况B（已安装未运行）：                             │   │
│  │  ⚠️ Ollama 已安装但未启动                           │   │
│  │  [启动 Ollama]  [使用云端API代替]                   │   │
│  │                                                     │   │
│  │  情况C（未安装）：                                   │   │
│  │  ❌ 未检测到 Ollama                                 │   │
│  │                                                     │   │
│  │  本地分析需要 Ollama（免费开源）                     │   │
│  │  [下载安装 Ollama]                                  │   │
│  │    ↳ 点击后打开 ollama.com 下载页面                 │   │
│  │                                                     │   │
│  │  或者使用云端 API（需要 API Key）                   │   │
│  │  [配置云端 API]                                     │   │
│  │                                                     │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  💡 还没准备好？先体验预分析的样本小说               │   │
│  │  [跳过，先体验样本小说 →]                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Ollama模型推荐（检测到已安装但无模型时）**：

```
┌─────────────────────────────────────────────────────────────┐
│  选择分析模型                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  检测到您的硬件：Apple M2 Pro, 16GB 内存                    │
│                                                             │
│  推荐模型：                                                 │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ⭐ qwen3:8b                          [下载 4.9GB]  │   │
│  │    推荐 · 16GB内存 · 分析质量优秀                    │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │    qwen3:4b                          [下载 2.6GB]  │   │
│  │    入门级 · 8GB内存可用 · 分析质量良好               │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │    qwen3:14b                         [下载 9.0GB]  │   │
│  │    高性能 · 32GB内存 · 分析质量最佳                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  下载后可在设置中随时切换模型                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 6.4.3 运行时LLM配置界面

**设计：设置页新增「AI引擎」配置面板（当前仅环境变量控制，需产品化）**

```
┌─────────────────────────────────────────────────────────────┐
│  设置 > AI 引擎                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  分析引擎                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ (•) 本地 Ollama（推荐，免费，数据不出设备）          │   │
│  │                                                     │   │
│  │     状态：✅ 运行中                                  │   │
│  │     模型：[qwen3:8b          ▼]  [刷新模型列表]     │   │
│  │     地址：http://localhost:11434  [测试连接]         │   │
│  │                                                     │   │
│  │     💡 如需更好的分析质量，建议下载 qwen3:14b        │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ ( ) 云端 API（需要 API Key，按用量计费）             │   │
│  │                                                     │   │
│  │     提供商：[DeepSeek             ▼]                │   │
│  │     API Key：[•••••••••••••••••]  [验证] ✅ 有效    │   │
│  │     模型：  [deepseek-chat        ▼]                │   │
│  │     Base URL：https://api.deepseek.com/v1           │   │
│  │                                                     │   │
│  │     🔒 API Key 加密存储在本地系统密钥库              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  高级选项                                                   │
│  ├── 最大Token数：[8192    ]                               │
│  ├── 请求超时：  [60秒    ]                                │
│  └── 并发请求数：[1       ] （单GPU建议保持1）             │
│                                                             │
│                                    [恢复默认]  [保存]      │
└─────────────────────────────────────────────────────────────┘
```

#### 6.4.4 API Key 安全存储

| 平台 | 存储方案 | 加密方式 |
|------|---------|---------|
| **macOS** | Keychain Services (`security` CLI) | 系统级AES-256加密 |
| **Windows** | Windows Credential Manager (`wincred`) | DPAPI加密 |
| **Linux** | libsecret / GNOME Keyring | 用户会话密钥加密 |
| **fallback** | 本地加密文件 `~/.ai-reader-v2/.credentials` | AES-256-GCM，密钥派生自机器指纹 |

**Python实现**：使用 `keyring` 库统一跨平台密钥存储，fallback到加密文件。API Key 绝不以明文写入配置文件或数据库。

#### 6.4.5 硬件配置推荐表

| 小说规模 | 章节数 | 字数 | 推荐模型 | 内存需求 | 单章分析速度 | 全书耗时估算 |
|---------|--------|------|---------|---------|-------------|-------------|
| 短篇 | < 50章 | < 15万字 | qwen3:4b | 8 GB | ~30秒/章 | ~25分钟 |
| 中篇 | 50-200章 | 15-60万字 | qwen3:8b | 16 GB | ~45秒/章 | ~1.5-3小时 |
| 长篇 | 200-500章 | 60-150万字 | qwen3:8b | 16 GB | ~45秒/章 | ~3-6小时 |
| 超长篇 | 500-2000章 | 150-600万字 | qwen3:14b | 32 GB | ~60秒/章 | ~8-33小时 |

*以上基于Apple M2 Pro测试。Intel/AMD CPU可能慢2-5倍。有NVIDIA GPU的Windows机器与Apple Silicon性能接近。*

---

### 6.5 分析成本控制系统

#### 6.5.1 成本预估模型

**Token消耗公式**（基于实际测试数据）：

```
单章Token消耗 ≈ 输入Token + 输出Token
├── 输入Token = 系统提示(~2000) + 上下文摘要(~1500) + 章节文本(章节字数×1.5) + 实体词典(~500)
├── 输出Token ≈ 2000-4000（ChapterFact JSON）
└── 典型值：一章3000字的小说 → 输入~8500 Token + 输出~3000 Token ≈ 11,500 Token/章

成本计算（以DeepSeek为例）：
├── deepseek-chat：输入 ¥1/百万Token，输出 ¥2/百万Token
├── 单章成本 ≈ ¥0.0085 + ¥0.006 = ¥0.015/章
└── 含实体预扫描：额外 +20% Token消耗

各规模小说云端成本预估：
├── 100章 × ¥0.015 ≈ ¥1.5
├── 500章 × ¥0.015 ≈ ¥7.5
├── 1000章 × ¥0.015 ≈ ¥15
└── 2000章 × ¥0.015 ≈ ¥30

注：OpenAI gpt-4o 约为 DeepSeek 价格的 10-20 倍
```

#### 6.5.2 分析前成本预览弹窗

**当用户使用云端LLM点击「开始分析」时弹出**：

```
┌─────────────────────────────────────────────────────────────┐
│  📊 分析成本预估                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  小说：《凡人修仙传》                                        │
│  分析范围：第1章 - 第500章（共500章，约150万字）             │
│  LLM提供商：DeepSeek (deepseek-chat)                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  预估Token消耗                                      │   │
│  │  ├── 输入Token：~4,250,000                          │   │
│  │  ├── 输出Token：~1,500,000                          │   │
│  │  └── 总计：~5,750,000 Token                         │   │
│  │                                                     │   │
│  │  预估费用：¥7.25                                    │   │
│  │  ├── 输入：¥4.25                                    │   │
│  │  └── 输出：¥3.00                                    │   │
│  │                                                     │   │
│  │  含实体预扫描：+¥1.45（可选）                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ⚠️ 实际费用可能因章节长度差异浮动 ±30%                     │
│                                                             │
│  本月已用：¥12.50 / 预算上限：¥50.00                        │
│  ████████░░░░░░░░░░░░ 25%                                  │
│                                                             │
│  [✓] 含实体预扫描（推荐，提升提取质量）                     │
│                                                             │
│  💡 切换到本地Ollama可免费分析 [切换到本地]                  │
│                                                             │
│            [取消]                    [确认分析 ¥8.70]       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 6.5.3 实时成本追踪仪表盘

**分析过程中的成本追踪（嵌入分析进度页面）**：

```
┌─────────────────────────────────────────────────────────────┐
│  正在分析：《凡人修仙传》                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  进度：258/500 章                                           │
│  ████████████████░░░░░░░░░░░░░░ 51.6%                     │
│  当前：第259章 · 墨蛟之战                                   │
│                                                             │
│  ┌── 实时统计 ──────────────────────────────────────────┐  │
│  │                                                      │  │
│  │  已用Token    已花费       预估剩余     预估总计       │  │
│  │  2,967,000   ¥3.71        ¥3.54       ¥7.25         │  │
│  │                                                      │  │
│  │  速度：~45秒/章  预计剩余：~3小时                     │  │
│  │                                                      │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  本月预算：¥16.21 / ¥50.00                                  │
│  ██████████░░░░░░░░░░░░░░░░░░░░ 32.4%                     │
│                                                             │
│  已发现实体：人物 89 · 地点 34 · 物品 45 · 组织 12          │
│                                                             │
│              [暂停]  [取消分析]                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 6.5.4 预算告警机制

| 告警阈值 | 触发条件 | 行为 |
|---------|---------|------|
| **80%预算** | 本月消费 ≥ 预算×80% | Toast提示："本月云端预算已用80%，剩余¥X" |
| **100%预算** | 本月消费 ≥ 预算 | 弹窗确认："已达到本月预算上限，继续分析将超出预算。[继续] [暂停] [切换本地]" |
| **单次分析超限** | 单次分析预估 > 预算剩余 | 分析前提示："本次分析预估¥X，超出本月剩余预算¥Y。[仍然开始] [调整范围] [切换本地]" |

#### 6.5.5 按章节成本明细

**分析完成后可查看详细成本**（设置 > 使用统计）：

```
┌─────────────────────────────────────────────────────────────┐
│  使用统计 > 《凡人修仙传》 分析记录                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  分析时间：2026-02-17 14:30 - 2026-02-17 21:15             │
│  LLM：DeepSeek deepseek-chat                                │
│  总费用：¥7.18                                              │
│                                                             │
│  章节     | 输入Token | 输出Token | 费用    | 实体数         │
│  ─────────────────────────────────────────────────────────  │
│  第1章    |    8,200  |    2,800  | ¥0.014 | 人5 地2 物1    │
│  第2章    |    9,100  |    3,200  | ¥0.015 | 人3 地1 物2    │
│  第3章    |   11,500  |    3,800  | ¥0.019 | 人4 地3 物0    │
│  ...                                                        │
│  第500章  |   12,300  |    4,100  | ¥0.020 | 人2 地1 物1    │
│  ─────────────────────────────────────────────────────────  │
│  合计     | 4,250,000 | 1,490,000 | ¥7.18 | 人89 地34 ...  │
│                                                             │
│  [导出CSV]                                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 6.5.6 分析中断与恢复

**成本处理规则**：
- 分析支持暂停/恢复，已完成章节的 ChapterFact 已写入数据库，不会重复消耗
- 用户取消分析后，已分析章节的结果保留可用
- 恢复分析时，从中断位置继续，不重复分析已完成章节
- 异常中断（崩溃/断网）：重启后检测到未完成任务，提示恢复（已完成章节不重跑）

---

### 6.6 隐私保护设计

```
隐私承诺：
1. 本地分析：LLM推理在本地完成，文本不上传
2. 可选同步：云端仅存储加密数据，密钥在用户手中
3. 零知识：我们无法访问用户的小说内容
4. 随时导出：支持完整数据导出，随时迁移
5. 随时删除：一键删除所有云端数据

技术实现：
- 本地LLM默认（Ollama）
- 云端LLM可选（需用户明确同意，仅发送章节文本用于分析）
- API Key 加密存储在系统密钥库（见6.4.4）
- 同步数据端到端加密（AES-256）
- 加密密钥本地生成，不上传
```

---

## 7. 用户界面

### 7.1 页面结构

```
/                          # 书架首页
/novel/:id/read            # 阅读页（含剧本模式切换）
/novel/:id/graph           # 人物关系图
/novel/:id/map             # 世界地图
/novel/:id/timeline        # 时间线
/novel/:id/factions        # 势力图
/novel/:id/export          # Series Bible导出中心
/novel/:id/chat            # 智能问答
/novel/:id/encyclopedia    # 百科
/novel/:id/analysis        # 分析管理
/settings                  # 设置（含AI引擎配置、使用统计）
/help                      # 帮助中心
```

### 7.2 关键交互设计

**实体高亮颜色**：
- 人物：蓝色
- 地点：绿色
- 物品：橙色
- 组织：紫色
- 概念：灰色

**实体卡片抽屉**：
- 右侧滑出，宽度420px
- 面包屑导航（支持回退）
- 卡片内实体可点击跳转

**导出中心界面**：
```
┌─────────────────────────────────────────────┐
│ Series Bible 导出                           │
├─────────────────────────────────────────────┤
│                                             │
│  选择格式：                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ Markdown │ │   Word   │ │  Excel   │   │
│  │   [icon] │ │   [icon] │ │   [icon] │   │
│  │          │ │          │ │          │   │
│  │ 适合：   │ │ 适合：   │ │ 适合：   │   │
│  │ 网文作者 │ │ 传统出版 │ │ IP改编   │   │
│  │          │ │          │ │          │   │
│  │ [选择]   │ │ [选择]   │ │ [选择]   │   │
│  └──────────┘ └──────────┘ └──────────┘   │
│                                             │
│  内容选择：                                  │
│  [✓] 人物档案    [✓] 势力分布    [✓] 地图 │
│  [✓] 时间线      [ ] 原始文本              │
│                                             │
│  模板：                                      │
│  [网文作者套件 ▼]                          │
│                                             │
│           [预览] [导出]                    │
│                                             │
└─────────────────────────────────────────────┘
```

**剧本模式界面**（见§5.3.3的设计细节）：
- 并列模式：左原文 + 右剧本场景列表，支持同步滚动
- 独占模式：全屏显示当前场景，顶部标签导航
- 场景结构：标题 + 时间 + 地点 + 角色 + 描述 + 对话

---

## 8. 帮助体系

### 8.1 四层帮助架构

```
📚 AI Reader V2 帮助体系
│
├── 🎯 第一层：上下文引导
│   ├── 功能高亮（首次使用）
│   ├── 工具提示（悬停即现）
│   ├── 空状态引导
│   └── 操作确认
│
├── 📖 第二层：结构化帮助
│   ├── 帮助中心（⌘⇧?）
│   ├── 功能指南
│   ├── 场景教程
│   └── FAQ
│
├── 🎓 第三层：主动教育
│   ├── 首次使用引导
│   ├── 新功能公告
│   └── Pro Tips
│
└── 🔍 第四层：自助支持
    ├── 快捷键面板（⌘K）
    ├── 故障排查向导
    └── 反馈入口
```

### 8.2 关键帮助内容

**首次使用引导**：
1. 环境配置检测（Ollama）
2. 样本小说功能体验（见§4.1旅程）
3. 上传第一本小说引导
4. 点击实体查看卡片
5. 智能问答入口提示

**场景教程**：
- 网文作者：管理百万字设定
- 编剧：从小说到剧本
- 游戏策划：构建世界观文档
- 编辑：跨书设定一致性检查

**快捷键**：
| 快捷键 | 功能 |
|--------|------|
| ⌘K | 打开智能问答 |
| ⌘⇧? | 显示帮助中心 |
| ⌘B | 切换侧边栏 |
| ⌘F | 全文搜索 |
| ⌘[ / ⌘] | 上一章/下一章 |

---

## 9. 非功能需求

### 9.1 性能需求

| 指标 | 目标值 | 测量条件 |
|------|--------|---------|
| 应用启动时间 | < 5秒 | 冷启动到书架页可交互 |
| 页面切换 | < 500ms | 任意页面间导航 |
| 关系图渲染 | < 3秒 | 400节点/1000边的力导向图 |
| 地图加载 | < 2秒 | 含50+地点标记的Leaflet地图 |
| 单章分析速度 | < 3分钟（本地7B）| 3000字章节，Apple M2, 16GB |
| 导出生成 | < 30秒 | 500章小说的完整Markdown导出 |
| 搜索响应 | < 1秒 | 全文搜索结果返回 |

### 9.2 安全需求

| 需求 | 实现方式 |
|------|---------|
| API Key 不明文存储 | 系统密钥库（Keychain/Credential Manager），见§6.4.4 |
| 本地数据保护 | 数据文件仅当前操作系统用户可读写（文件权限600，目录权限700） |
| 云端通信加密 | 所有API请求使用HTTPS（TLS 1.2+） |
| 更新包验证 | 应用更新包需数字签名验证，防止中间人替换 |
| 无远程遥测 | 默认不上传任何数据，埋点数据仅本地存储 |

### 9.3 可用性需求

| 需求 | 目标 |
|------|------|
| 离线运行 | 本地LLM模式下100%功能可用（无需网络） |
| 数据可迁移 | 一键导出全部数据为JSON，支持跨设备导入 |
| 容错恢复 | 分析中断后可从断点恢复，已分析数据不丢失 |
| 多语言UI | v1.0仅中文；v2.0考虑英文/日文 |

### 9.4 兼容性需求

| 需求 | 范围 |
|------|------|
| 操作系统 | macOS 12+, Windows 10 1803+, Ubuntu 20.04+（见§6.1.2） |
| WebView | macOS: WKWebView; Windows: WebView2（Edge Chromium） |
| Ollama版本 | 0.3.0+（支持OpenAI兼容API） |
| 小说编码 | UTF-8（自动检测GBK/GB2312并转换） |
| 最大小说体积 | 单本 < 50MB（约1500万字） |

---

## 10. 用户行为分析系统

### 10.1 设计目标

建立用户行为数据统计体系，为产品迭代提供数据依据，实现数据驱动的产品优化。

### 10.2 数据收集范围

**功能使用数据（本地匿名统计，用户可选择关闭）**：

| 数据类型 | 具体内容 | 用途 |
|---------|---------|------|
| 功能使用频率 | 各功能点击次数、使用时长 | 识别核心功能 vs 冷门功能 |
| 导出格式偏好 | 各导出格式使用占比 | 优化导出功能优先级 |
| 分析完成率 | 上传小说 → 完成分析转化率 | 优化分析流程体验 |
| 实体查看路径 | 用户如何浏览实体卡片 | 优化信息架构 |
| 问答使用模式 | 常见问题类型、满意度 | 优化问答质量 |

**性能数据（仅技术优化用途）**：
- 分析耗时分布
- 内存占用峰值
- 崩溃/错误日志

### 10.3 数据存储与隐私

```
隐私原则：
1. 完全匿名：不收集用户身份、小说内容
2. 本地优先：统计数据本地存储，定期汇总上报（可选）
3. 用户控制：设置中可完全关闭数据统计
4. 透明公开：统计代码开源，可审计

数据示例（脱敏后）：
{
  "event": "export_used",
  "format": "excel",
  "template": "game_designer",
  "novel_size": "large",
  "timestamp": "2026-02-17T09:30:00Z"
}
```

### 10.4 关键指标看板

**产品健康度指标**：
| 指标 | 定义 | 目标值 |
|------|------|--------|
| 激活率 | 下载 → 完成首次分析 | > 60% |
| 7日留存 | 7天内再次使用 | > 50% |
| 功能渗透率 | 使用导出功能的用户占比 | > 40% |
| 付费转化率 | 免费 → Pro | > 10% |

**功能优化指标**：
| 指标 | 用途 |
|------|------|
| 导出格式占比 | 决定开发资源分配 |
| 剧本模式使用率 | 验证功能价值 |
| 实体卡片平均查看时长 | 评估内容质量 |
| 问答满意度评分 | 优化AI回答质量 |

### 10.5 数据驱动迭代流程

```
数据收集 → 分析洞察 → 假设形成 → A/B测试 → 功能优化 → 效果验证
    ↑                                                            │
    └────────────────────────────────────────────────────────────┘

示例：
1. 数据显示：仅30%用户发现导出功能
2. 假设：入口太深，用户不知道有此功能
3. 优化：在阅读页增加导出快捷入口
4. 验证：一周后渗透率提升至45%
```

---

## 11. 商业化策略

### 11.1 版本与定价

| 版本 | 价格 | 目标用户 | 核心功能 |
|------|------|---------|---------|
| **免费版** | ¥0 | 个人尝试 | 5本小说（含样本），基础功能，Markdown导出，每本累计50次Q&A |
| **Pro版** | ¥299买断（含1年更新）<br/>续费¥149/年 | 专业作者 | 无限小说，Word/Excel/PDF导出，无限Q&A，设定锁定 |
| **团队版** | ¥99/人/月（5人起） | 工作室/改编团队 | Pro全部功能 + 批量授权 + 优先支持 |
| **企业版** | 定制（¥50,000/年起） | 游戏/影视公司 | 私有化部署 + 批量License + 定制开发 |

### 11.2 付费转化策略

**免费版限制**：
- 第6本小说上传时提示"升级Pro解锁无限小说"
- 导出页显示"Word/Excel/PDF导出需要Pro"
- Q&A累计50次后提示升级

**转化触发点**：
- 尝试导出Word/Excel时展示Pro预览
- 样本小说体验后提示"分析你自己的小说"
- 第7天推送Pro功能介绍

### 11.3 收入预测

| 阶段 | 时间 | MAU | 付费用户 | MRR |
|------|------|-----|---------|-----|
| MVP | 3个月 | 10,000 | 500 | ¥20,000 |
| 商业化 | 6个月 | 30,000 | 2,000 | ¥100,000 |
| 扩张 | 12个月 | 100,000 | 5,000 | ¥500,000 |
| 规模化 | 24个月 | 300,000 | 15,000 | ¥2,000,000 |

---

## 12. 实施路线图

### 12.1 Phase 1: MVP（3个月）

**目标**：验证核心价值和用户需求

**交付物**：
- 桌面应用（Windows/macOS，Tauri打包）
- 本地LLM集成（Ollama）+ 云端LLM配置
- 基础分析功能
- 实体卡片系统
- 人物关系图
- Markdown导出
- 样本小说内置体验（西游记 + 三国演义）
- 分析成本预估与追踪（云端模式）

**成功指标**：
- 下载量 > 10,000
- 激活率 > 60%
- NPS > 40

### 12.2 Phase 2: 商业化（2个月）

**目标**：建立收入流

**交付物**：
- Pro功能解锁 + 授权系统
- 支付系统接入
- Word/Excel/PDF导出
- 跨设备加密同步
- 剧本模式初版（实验性，需收集反馈）

**成功指标**：
- 转化率 > 10%
- MRR > ¥10,000
- 用户留存（7日）> 50%

### 12.3 Phase 3: 功能完善（3个月）

**目标**：功能完善与商业化优化

**交付物**：
- 剧本模式深入研究（与专业编剧合作）
- 用户行为分析系统
- 导出模板市场
- 设定冲突检测
- Windows ARM64 支持

**成功指标**：
- 剧本模式用户满意度 > 4.0/5
- 数据驱动功能优化 > 5项
- 付费转化率 > 15%

### 12.4 Phase 4: 规模化与云端探索（持续）

**目标**：市场扩张，评估云端协作可行性

**交付物**：
- Linux支持
- 移动端App（查看模式，PWA或原生）
- 插件生态
- 国际化
- 云端协作（根据用户需求评估）

---

## 13. 附录

### 13.1 术语表

| 术语 | 定义 |
|------|------|
| ChapterFact | 每章提取的结构化数据（实体、关系、事件、概念） |
| Series Bible | 系列作品设定文档，包含完整的世界观、角色、设定 |
| 实体 | 小说中的对象：人物、地点、物品、组织、概念 |
| 本地优先 | 数据默认存储在本地设备，不上传云端 |
| 剧本模式 | 将小说文本转换为场景化剧本格式的视图（实验性功能） |
| Sidecar | Tauri打包时捆绑的外部可执行文件（本项目中为Python后端） |
| BYOK | Bring Your Own Key — 用户自带LLM API Key，产品不承担推理成本 |

### 13.2 竞品分析

| 产品 | 模式 | 优势 | 劣势 | 与AI Reader的差异 |
|------|------|------|------|------------------|
| Notion | SaaS | 协作强，生态丰富 | 无隐私保护，无AI分析 | 通用工具 vs 垂直场景 |
| Obsidian | 本地 | 隐私好，插件生态 | 无AI分析，需手动维护 | 我们是自动提取 |
| 橙瓜码字 | SaaS | 垂直写作场景 | 无知识图谱，平台锁定 | 我们数据完全本地 |
| Scrivener | 本地 | 专业写作，口碑好 | 无AI功能，¥278买断 | 我们AI原生 |
| Plottr | SaaS | 可视化大纲 | 需手动录入设定 | 我们自动提取（代际差异） |
| World Anvil | SaaS | 世界观Wiki | 需手动构建，月费$5-13 | 我们从文本自动生成 |

**我们的差异化**：本地隐私 + AI自动提取（vs 手动录入）+ 剧本模式 + Series Bible多格式导出

### 13.3 风险与对策

| 风险 | 可能性 | 影响 | 对策 |
|------|--------|------|------|
| 本地LLM体验不佳 | 中 | 高 | 优化提示词，支持云端LLM fallback，硬件配置引导 |
| 用户不接受订阅本地软件 | 中 | 高 | 采用买断+年度更新续费模式（非纯订阅） |
| 盗版/破解 | 高 | 中 | 离线License验证，接受少量盗版，Pro更新价值驱动续费 |
| 竞品模仿 | 高 | 中 | 快速迭代，建立社区生态，本地隐私是大厂无法提供的 |
| Tauri+Python sidecar兼容性 | 中 | 中 | 充分测试三平台，保留纯Web模式作为fallback |
| Ollama安装门槛吓退用户 | 中 | 高 | 样本小说零配置体验 + 云端API一键配置 |

---

## 文档历史

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v0.1 | 2025-01-01 | 初始PRD |
| v1.0 | 2026-02-17 | 整合用户研究、功能对齐、交付模式分析，正式发布 |
| v1.1 | 2026-02-17 | 深化平台规划(Tauri+系统要求+签名)、LLM配置(零配置体验+Key安全+硬件表)、成本控制系统(预览弹窗+实时追踪+预算告警)、样本小说(公版名著方案+预计算存储+教学融合)；新增成功标准§2、用户旅程§4、非功能需求§9；修复章节编号冲突；商业化模型调整为买断+更新续费 |
| v1.2 | 2026-02-17 | BMAD验证修复：§5.2.5实现细节迁移至Architecture引用、§9.2安全需求去技术化（SQLite/ChromaDB→能力描述、Tauri→通用描述）、PDF导出"精美排版"量化为"专业排版（含目录/页码/页眉）"、模板变量`XX-XX`填充、冗余尾句删除 |
| v1.3 | 2026-02-17 | BMAD结构性改进：新增§5.3正式FR列表（FR-001~FR-015，`[用户]可以[能力]`格式）；新增J4智能问答旅程、J5设定审查旅程（消除3个孤儿FR）；新增§5.4.5时间线和§5.4.6势力图详细设计；§5.5整合为MVP/Growth/Vision三层产品范围（BMAD核心章节6/6）；§2.2新增隐私信任度指标；添加YAML frontmatter；J1-J3添加FR追溯引用 |

---

*AI Reader V2 - 让每一部小说都有结构化的知识管理*
